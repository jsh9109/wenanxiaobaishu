<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOå†…å®¹çŸ©é˜µç”Ÿæˆç³»ç»Ÿ - v5.4 ç»ˆæçˆ†æ¬¾ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* v5.4 é£æ ¼ - æç®€é«˜æ•ˆ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .header { background: #1890ff; color: white; padding: 25px; text-align: center; position: relative; }
        .header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 500; }
        
        .top-bar { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
        .history-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .history-btn:hover { background: rgba(255,255,255,0.3); }

        .content { padding: 30px; }
        .section { background: #fff; border-radius: 6px; padding: 20px; margin-bottom: 20px; border: 1px solid #e8e8e8; border-left: 4px solid #1890ff; }
        .section-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .info-box { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; padding: 12px; border-radius: 4px; font-size: 13px; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 500; margin-right: 10px; transition: 0.2s; }
        .btn-blue { background: #1890ff; }
        .btn-green { background: #52c41a; }
        .btn-orange { background: #fa8c16; }
        .log { margin-top: 15px; padding: 15px; background: #fafafa; color: #333; border-radius: 4px; max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #eee; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; }
        
        /* èƒ¶å›ŠæŒ‰é’®ç»„ */
        .input-group { display: flex; gap: 10px; }
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .history-list { list-style: none; padding: 0; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .history-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ æˆ’æŒ‡SEOå†…å®¹å·¥å‚ v5.4 (ç»ˆæçˆ†æ¬¾ç‰ˆ)</h1>
            <p>é‡è·¯å­æ–‡æ¡ˆ | å¼ºåˆ¶åˆ†æ®µ | è‡ªåŠ¨è®°å¿†Key</p>
            <div class="top-bar">
                <button class="history-btn" onclick="showHistoryModal()">ğŸ“œ å†å²è®°å½• (æœ€è¿‘5æ¬¡)</button>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“¥ æ­¥éª¤ 0ï¼šæ¨¡æ¿å‡†å¤‡</div>
                <div class="info-box">
                    ğŸ”¥ <b>æ¨¡æ¿å·²æ›´æ–°ï¼š</b><br>
                    å†…ç½®äº†<b>"çˆ†æ¬¾ä¿®æ­£æ¨¡å¼"</b>æŒ‡ä»¤ï¼Œä¸“é—¨ç”Ÿæˆé‚£ç§<b>"çŸ­å¥+ç—›ç‚¹+åœºæ™¯"</b>çš„é‡è·¯å­æ–‡æ¡ˆã€‚<br>
                    è¯·åŠ¡å¿…ä¸‹è½½æ–°æ¨¡æ¿ä½¿ç”¨ï¼
                </div>
                <button class="btn btn-blue" onclick="downloadSmartTemplate()">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿_v5.4_ä¿®æ­£çˆ†æ¬¾ç‰ˆ.xlsx</button>
            </div>

            <div class="section">
                <div class="section-title">ğŸ”Œ æ­¥éª¤ 1ï¼šé…ç½® API (å·²æ”¯æŒè®°å¿†)</div>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                    <button class="btn btn-green" onclick="saveApiKey()" style="margin-right:0;">ğŸ’¾ ä¿å­˜ Key</button>
                </div>
                <div id="keyStatus" style="font-size:12px; color:green; margin-top:5px; height:18px;"></div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“‚ æ­¥éª¤ 2ï¼šä¸Šä¼ æ‚¨çš„è¡¨æ ¼</div>
                <input type="file" id="systemFile" accept=".xlsx,.xls" onchange="handleSystemFile()">
                <div id="fileStatus" class="hidden" style="margin-top:10px; color:#52c41a; font-weight:bold;"></div>
            </div>

            <div class="section hidden" id="configSection">
                <div class="section-title">âš™ï¸ æ­¥éª¤ 3ï¼šé€‰æ‹©æŒ‡ä»¤å¹¶æ‰§è¡Œ</div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; font-size:12px; color:#666;">è¯·é€‰æ‹© Excel ä¸­å®šä¹‰çš„æŒ‡ä»¤ï¼š</label>
                    <select id="promptTemplate"><option value="">-- è¯·é€‰æ‹© --</option></select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-blue" id="startBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿäº§</button>
                    <button class="btn btn-orange hidden" id="pauseBtn" onclick="togglePause()">â¸ï¸ æš‚åœ (å¯å¯¼å‡º)</button>
                    <button class="btn btn-green hidden" id="downloadBtn" onclick="downloadResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                </div>
                
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ’¾ æœ€è¿‘ç”Ÿæˆè®°å½•</h3>
            <ul class="history-list" id="historyListUi"></ul>
            <button class="btn btn-gray" onclick="document.getElementById('historyModal').style.display='none'" style="width:100%; margin-top:10px;">å…³é—­</button>
        </div>
    </div>

    <script>
        const SHEET_NAMES = { keywords: "ğŸ”SEOå…³é”®è¯åº“", prompts: "ğŸ¤–AIç”ŸæˆæŒ‡ä»¤", tags: "ğŸ·ï¸è¯é¢˜æ ‡ç­¾SEOåº“", titles: "ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“" };
        let GLOBAL_DATA = { keywords: [], prompts: [], tags: [], titles: [], generated: [] };
        let isPaused = false;

        // ğŸŸ¢ Key è®°å¿†
        window.onload = function() {
            const savedKey = localStorage.getItem('xhs_user_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('keyStatus').textContent = "âœ… å·²è‡ªåŠ¨åŠ è½½æœ¬åœ°ä¿å­˜çš„ Key";
            }
        };
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return alert("è¯·å…ˆè¾“å…¥ Key");
            localStorage.setItem('xhs_user_api_key', key);
            document.getElementById('keyStatus').textContent = "âœ… Key å·²ä¿å­˜ï¼Œä¸‹æ¬¡æ— éœ€è¾“å…¥ï¼";
            alert("Key å·²ä¿å­˜ï¼");
        }

        // ğŸŸ¢ å¤šæ¡å†å²è®°å½• (æœ€è¿‘5æ¡)
        function saveToHistoryList(data) {
            if (!data || data.length === 0) return;
            let history = JSON.parse(localStorage.getItem('xhs_history_list_v5') || "[]");
            
            // å¦‚æœæ˜¯åŒä¸€ä¸ªä»»åŠ¡çš„å»¶ç»­ï¼ˆæ¯”å¦‚æš‚åœåç»§ç»­ï¼‰ï¼Œæ›´æ–°æœ€æ–°ä¸€æ¡ï¼›å¦åˆ™æ–°å¢
            // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šæ¯æ¬¡å®Œæˆæˆ–æš‚åœå¯¼å‡ºæ—¶ï¼Œæ–°å¢ä¸€æ¡è®°å½•
            const record = {
                id: new Date().getTime(),
                time: new Date().toLocaleString(),
                count: data.length,
                data: data
            };
            
            history.unshift(record);
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('xhs_history_list_v5', JSON.stringify(history));
        }

        function showHistoryModal() {
            const history = JSON.parse(localStorage.getItem('xhs_history_list_v5') || "[]");
            const ui = document.getElementById('historyListUi');
            ui.innerHTML = "";
            if(history.length === 0) ui.innerHTML = "<li style='color:#999;text-align:center;'>æš‚æ— è®°å½•</li>";
            
            history.forEach((rec, idx) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `<div>${rec.time} <span style="font-size:12px;color:#999;">(${rec.count}æ¡)</span></div> <a href="#" style="color:#1890ff;">ä¸‹è½½</a>`;
                li.onclick = () => {
                    exportExcel(rec.data, `å†å²æ¢å¤_${rec.id}.xlsx`);
                    document.getElementById('historyModal').style.display = 'none';
                };
                ui.appendChild(li);
            });
            document.getElementById('historyModal').style.display = 'flex';
        }

        function exportExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿæˆç»“æœ");
            XLSX.writeFile(wb, filename);
        }

        // ğŸŸ¢ æ¨¡æ¿ä¸‹è½½ï¼šæ³¨å…¥ v5.4 ä¿®æ­£æŒ‡ä»¤
        function downloadSmartTemplate() {
            const wb = XLSX.utils.book_new();
            const wsKw = XLSX.utils.aoa_to_sheet([["å…³é”®è¯", "ä¼˜å…ˆçº§", "ä»·æ ¼", "æè´¨", "å¤‡æ³¨"], ["æ°´æ³¢çº¹æˆ’æŒ‡", "â­â­â­", "13.9", "é“¶è‰²è´¨æ„Ÿ", "ç¤ºä¾‹"]]);
            XLSX.utils.book_append_sheet(wb, wsKw, SHEET_NAMES.keywords);
            
            // ğŸ”¥ æ ¸å¿ƒä¿®æ­£æŒ‡ä»¤
            const promptsData = [
                ["æŒ‡ä»¤åç§°", "æŒ‡ä»¤å†…å®¹"],
                ["æŒ‡ä»¤1ï¼šçˆ†æ¬¾ä¿®æ­£æ¨¡å¼", `ã€è§’è‰²è®¾å®šã€‘\nä½ æ˜¯ä¸€ä¸ªæ¿€åŠ¨å¾—è¯­æ— ä¼¦æ¬¡çš„å¥³ç”Ÿï¼Œå‘ç°äº†æƒŠå¤©å¤§æ¼ï¼Œæ­£åœ¨ç¾¤é‡Œè·Ÿå§å¦¹å–Šè¯ã€‚\n\nã€æ ¸å¿ƒå…³é”®è¯ã€‘{ä»SEOå…³é”®è¯åº“é€‰æ‹©}\n\nã€æ ‡é¢˜è¦æ±‚ã€‘\nå¿…é¡»ç”¨"å¯¹è¯ä½“" + "åœºæ™¯" + "æ•°å­—"ï¼\nç¤ºä¾‹ï¼š\n- åŒäº‹ï¼šä½ è¿™æˆ’æŒ‡å¤§ç‰Œå§ï¼Ÿæˆ‘ï¼š13.9ï¼\n- æ•‘å‘½ğŸ†˜é—ºèœœéæŠ¢æˆ‘æ‰‹ä¸Šçš„æˆ’æŒ‡ï¼\n\nã€æ­£æ–‡è¦æ±‚ - æ ¸å¿ƒï¼ã€‘\n1. æ ¼å¼ï¼šæ¯ä¸€å¥è¯éƒ½è¦æ¢è¡Œï¼ä¸è¦ç”¨é€—å·è¿èµ·æ¥ã€‚\n2. å†…å®¹ï¼šä¸è¦å†™åºŸè¯ï¼æ¯ä¸€å¥éƒ½è¦æœ‰"ç”»é¢æ„Ÿ"æˆ–"ç—›ç‚¹"ã€‚\n3. å¿…é¡»åŒ…å«ä»¥ä¸‹ 4 å¥ï¼ˆé¡ºåºå¯æ¢ï¼‰ï¼š\n   - åœºæ™¯å¥ï¼š(æ¯”å¦‚ï¼šåˆšæˆ´å»å…¬å¸å°±è¢«å›´è§‚äº†)\n   - ç—›ç‚¹å¥ï¼š(æ¯”å¦‚ï¼šæ‰‹é»‘æ‰‹ç²—çš„å§å¦¹é—­çœ¼å†²)\n   - ç»†èŠ‚å¥ï¼š(æ¯”å¦‚ï¼š{æè´¨} åœ¨ç¯å…‰ä¸‹é—ªçˆ†äº†)\n   - é€¼å•å¥ï¼š(æ¯”å¦‚ï¼šè€æ¿è¯´åªå‰©æœ€åå‡ ä»¶ / {ä»·æ ¼} ä¹°åˆ°è¿™ç§è´¨æ„ŸçœŸçš„å“­æ­»)\n\nè¯·è¾“å‡ºï¼š\næ ‡é¢˜\næ­£æ–‡`],
            ];
            const wsPrompt = XLSX.utils.aoa_to_sheet(promptsData);
            XLSX.utils.book_append_sheet(wb, wsPrompt, SHEET_NAMES.prompts);

            const wsTags = XLSX.utils.aoa_to_sheet([["æ ‡ç­¾å†…å®¹", "æ ‡ç­¾ç±»å‹"], ["#æˆ’æŒ‡", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"], ["#æˆ’æŒ‡æ¨è", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"]]);
            XLSX.utils.book_append_sheet(wb, wsTags, SHEET_NAMES.tags);
            const wsTitles = XLSX.utils.aoa_to_sheet([["çˆ†æ¬¾æ ‡é¢˜å†…å®¹"], ["æ•‘å‘½ğŸ†˜13.9çš„æˆ’æŒ‡è¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ï¼Ÿï¼"]]);
            XLSX.utils.book_append_sheet(wb, wsTitles, SHEET_NAMES.titles);

            XLSX.writeFile(wb, "æ ‡å‡†å¡«ç©ºæ¨¡æ¿_v5.4_ä¿®æ­£çˆ†æ¬¾ç‰ˆ.xlsx");
        }

        // --- æ–‡ä»¶è¯»å– ---
        function handleSystemFile() {
            const file = document.getElementById('systemFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const findSheet = (name) => workbook.SheetNames.find(n => n.includes(name.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, "")));
                    
                    let s1 = workbook.Sheets[SHEET_NAMES.keywords] || workbook.Sheets[findSheet("SEOå…³é”®è¯åº“")];
                    let s2 = workbook.Sheets[SHEET_NAMES.prompts] || workbook.Sheets[findSheet("AIç”ŸæˆæŒ‡ä»¤")];
                    let s3 = workbook.Sheets[SHEET_NAMES.tags] || workbook.Sheets[findSheet("è¯é¢˜æ ‡ç­¾SEOåº“")];
                    let s4 = workbook.Sheets[SHEET_NAMES.titles] || workbook.Sheets[findSheet("çˆ†æ¬¾æ ‡é¢˜åº“")];

                    if(s1) GLOBAL_DATA.keywords = XLSX.utils.sheet_to_json(s1);
                    if(s2) GLOBAL_DATA.prompts = XLSX.utils.sheet_to_json(s2);
                    if(s3) GLOBAL_DATA.tags = XLSX.utils.sheet_to_json(s3);
                    if(s4) GLOBAL_DATA.titles = XLSX.utils.sheet_to_json(s4).map(r => Object.values(r)[0]);

                    if (!s1 || !s2) return alert("âŒ è¡¨æ ¼ä¸å®Œæ•´");

                    document.getElementById('fileStatus').innerHTML = `âœ… åŠ è½½æˆåŠŸ`;
                    document.getElementById('fileStatus').classList.remove('hidden');
                    
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    GLOBAL_DATA.prompts.forEach((row, i) => { if(row['æŒ‡ä»¤åç§°']) select.innerHTML += `<option value="${i}">${row['æŒ‡ä»¤åç§°']}</option>`; });
                    document.getElementById('configSection').classList.remove('hidden');
                } catch (err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function getTags() {
            if(!GLOBAL_DATA.tags.length) return "#æ¨è";
            const fixed = GLOBAL_DATA.tags.filter(t => t['æ ‡ç­¾ç±»å‹'] && t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            const others = GLOBAL_DATA.tags.filter(t => !t['æ ‡ç­¾ç±»å‹'] || !t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            return [...fixed, ...others.sort(() => 0.5 - Math.random()).slice(0, 7)].join(" ");
        }

        function getRandomTitles(count) {
            if (!GLOBAL_DATA.titles || GLOBAL_DATA.titles.length === 0) return "";
            const shuffled = [...GLOBAL_DATA.titles].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map((t, i) => `${i+1}. ${t}`).join("\n");
        }

        // --- æš‚åœä¸ç”Ÿæˆ ---
        function togglePause() {
            if (isPaused) {
                isPaused = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ (å¯å¯¼å‡º)";
                document.getElementById('pauseBtn').className = "btn btn-orange";
            } else {
                isPaused = true;
                document.getElementById('pauseBtn').innerText = "â–¶ï¸ å·²æš‚åœ (ç‚¹å‡»ç»§ç»­)";
                document.getElementById('pauseBtn').className = "btn btn-green";
                // æš‚åœæ—¶ä¿å­˜å¹¶å…è®¸å¯¼å‡º
                saveToHistoryList(GLOBAL_DATA.generated);
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        function downloadResult() {
            if (!GLOBAL_DATA.generated || GLOBAL_DATA.generated.length === 0) return alert("æ— æ•°æ®");
            const now = new Date();
            const timeStr = `${now.getHours()}${now.getMinutes()}`;
            exportExcel(GLOBAL_DATA.generated, `ç”Ÿæˆç»“æœ_${timeStr}.xlsx`);
            // å¯¼å‡ºæ—¶ä¹Ÿé¡ºä¾¿ä¿å­˜ä¸€æ¡å†å²
            saveToHistoryList(GLOBAL_DATA.generated);
        }

        async function startGeneration() {
            let apiKey = document.getElementById('apiKey').value;
            if (!apiKey) apiKey = localStorage.getItem('xhs_user_api_key');
            
            const pIdx = document.getElementById('promptTemplate').value;
            if(!apiKey || pIdx === "") return alert("è¯·é…ç½®APIå’ŒæŒ‡ä»¤");

            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            
            isPaused = false; 
            
            const promptRow = GLOBAL_DATA.prompts[pIdx];
            const originalTemplate = promptRow['æŒ‡ä»¤å†…å®¹'];
            const log = document.getElementById('log');
            GLOBAL_DATA.generated = [];
            const tasks = GLOBAL_DATA.keywords;

            for(let i=0; i<tasks.length; i++) {
                while(isPaused) { await new Promise(r => setTimeout(r, 500)); }

                const row = tasks[i];
                const kw = row['å…³é”®è¯'];
                if(!kw) continue;

                let finalPrompt = originalTemplate;
                finalPrompt = finalPrompt.replace(/\{ä»SEOå…³é”®è¯åº“é€‰æ‹©\}/g, kw).replace(/\{å…³é”®è¯\}/g, kw);
                const price = row['ä»·æ ¼'] || "13.9"; 
                finalPrompt = finalPrompt.replace(/\{ä»·æ ¼\}/g, price);
                const material = row['æè´¨'] || "é“¶è‰²è´¨æ„Ÿ";
                finalPrompt = finalPrompt.replace(/\{æè´¨\}/g, material);
                
                const randomExamples = getRandomTitles(5);
                if (finalPrompt.includes("{éšæœºçˆ†æ¬¾æ ‡é¢˜}")) {
                    finalPrompt = finalPrompt.replace(/\{éšæœºçˆ†æ¬¾æ ‡é¢˜\}/g, randomExamples);
                } else if (randomExamples) {
                    finalPrompt += `\n\nã€å‚è€ƒä»¥ä¸‹çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘\n${randomExamples}`;
                }

                log.innerHTML += `<div>[${i+1}/${tasks.length}] æ­£åœ¨ç”Ÿæˆ: <b>${kw}</b></div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const res = await fetch("https://api.gptsapi.net/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                        body: JSON.stringify({ model: "gpt-4o", messages: [{role: "user", content: finalPrompt}], temperature: 0.8 })
                    });
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    const content = json.choices[0].message.content;
                    
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let title = "æœªç”Ÿæˆ";
                    let body = "";

                    if(lines.length > 0) {
                        let candidate = lines[0].replace(/\*\*/g, '').replace(/æ ‡é¢˜[:ï¼š]/g, '').trim();
                        if(candidate.length > 20) candidate = candidate.substring(0, 20); 
                        title = candidate;
                        lines.shift();
                        
                        let rawBody = lines.join('\n'); 
                        body = rawBody.replace(/æ­£æ–‡[:ï¼š]/g, '').replace(/#\S+/g, '').trim();
                        body = body.split(/è¯é¢˜æ ‡ç­¾|Tags/i)[0].trim();
                        
                        if (!body.includes('\n')) body = body.replace(/([ã€‚ï¼ï¼Ÿ])/g, "$1\n\n");
                    }

                    GLOBAL_DATA.generated.push({
                        "åºå·": i+1,
                        "å…³é”®è¯": kw,
                        "æ ‡é¢˜": title,
                        "æ­£æ–‡": body, 
                        "è¯é¢˜æ ‡ç­¾": getTags(),
                        "å¤‡æ³¨": `ğŸ’°${price} / ğŸ’${material}`
                    });
                    
                } catch(e) { log.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`; }
                await new Promise(r => setTimeout(r, 800));
            }

            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            log.innerHTML += `<div style="color:#0f0">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
            downloadResult();
        }
    </script>
</body>
</html>
