<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨ - v7.0 ç»ˆæç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .admin-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(255,255,255,0.3); }
        .content { padding: 30px; }
        .section { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; align-items: center; justify-content: space-between; }
        .info-box { background: white; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 15px; border-radius: 4px; font-size: 13px; color: #666; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="date"], input[type="file"], select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .code-display { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }
        .progress-container { margin-top: 20px; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; }
        .log { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.8; }
        .log-item { margin-bottom: 5px; padding: 5px; border-left: 3px solid #667eea; padding-left: 10px; }
        .history-bar { display: flex; align-items: center; justify-content: space-between; background: #fff3e0; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; }
        .history-info { font-size: 13px; color: #e65100; }
        .highlight-box { background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border: 2px solid #667eea; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .highlight-title { font-size: 16px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .feature-list { list-style: none; padding: 0; }
        .feature-list li { padding: 8px 0; padding-left: 25px; position: relative; }
        .feature-list li:before { content: "âœ¨"; position: absolute; left: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="admin-btn" onclick="window.location.reload()" style="left: 20px; right: auto;">ğŸ”„ åˆ·æ–°</button>
            <h1>ğŸ¨ å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨</h1>
            <p>v7.0 ç»ˆæç‰ˆ - å°é¢æ–‡å­— | åœºæ™¯åŒ– | è¯æœ¯åº“ | 750å­—</p>
            <button class="admin-btn" onclick="showAdminModal()">âš™ï¸ ç®¡ç†</button>
        </div>
        
        <div class="content">
            <!-- æ¿€æ´»éƒ¨åˆ† -->
            <div class="section" id="activationSection">
                <div class="section-title">ğŸ”‘ è½¯ä»¶æ¿€æ´»</div>
                <div class="form-group">
                    <label>è¯·è¾“å…¥æ¿€æ´»ç </label>
                    <input type="text" id="activationCode" placeholder="XHS-ALL-xxxx-xxxx">
                </div>
                <button class="btn btn-primary" onclick="activate()">æ¿€æ´»è½¯ä»¶</button>
                <div class="status hidden" id="activationStatus"></div>
            </div>
            
            <div class="section hidden" id="activatedInfo">
                <div class="section-title">âœ… å·²æ¿€æ´»</div>
                <p>ä¸šåŠ¡çº¿: <span id="businessInfo"></span></p>
                <p>åˆ°æœŸæ—¶é—´: <span id="expireInfo"></span></p>
                <button class="btn btn-secondary" onclick="resetActivation()">é€€å‡ºç™»å½•</button>
            </div>

            <!-- APIé…ç½® -->
            <div class="section hidden" id="apiConfigSection">
                <div class="section-title">ğŸ”Œ API é…ç½® (Claude 3.5)</div>
                <div class="info-box">
                    <p>âš ï¸ éœ€ç”¨æˆ·è‡ªå¤‡ Keyã€‚v7.0ä¸“é—¨é’ˆå¯¹"ç¤¾ä¼šåŒ–æŒ‡å—"æ·±åº¦ä¼˜åŒ–ã€‚</p>
                </div>
                <div class="form-group">
                    <label>API Key (ä»¥ sk- å¼€å¤´)</label>
                    <input type="password" id="userApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                <button class="btn btn-primary" onclick="saveUserApiKey()">ğŸ’¾ ä¿å­˜ Key</button>
                <div class="status hidden" id="apiStatus"></div>
            </div>
            
            <!-- æ­¥éª¤1ï¼šæ™ºèƒ½åˆ†é… -->
            <div class="section hidden" id="assignSection">
                <div class="section-title">ğŸ” æ­¥éª¤1ï¼šæ™ºèƒ½åˆ†é…é€‰é¢˜</div>
                <div class="info-box">
                    <strong>âœ… v7.0å‡çº§ï¼š</strong><br>
                    â€¢ æ™ºèƒ½åˆ†é…3ç§æ¨¡æ¿ç±»å‹ï¼ˆè§‚å¯Ÿå¼ã€æ•…äº‹å¼ã€æ–¹æ³•å¼ï¼‰<br>
                    â€¢ ç¡®ä¿æ–‡æ¡ˆç»“æ„æœ‰å·®å¼‚åŒ–
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadBlankTemplate()">ğŸ“¥ ä¸‹è½½ç©ºç™½æ¨¡æ¿</button>
                    <button class="btn btn-success" onclick="document.getElementById('assignFile').click()">ğŸ“¤ ä¸Šä¼ å¹¶åˆ†é…</button>
                </div>
                <input type="file" id="assignFile" accept=".xlsx,.xls" style="display:none" onchange="handleAssignFile()">
                <div class="status hidden" id="assignFileInfo"></div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šAIç”Ÿæˆ -->
            <div class="section hidden" id="generateSection">
                <div class="section-title">
                    <span>ğŸ“ æ­¥éª¤2ï¼šAI æ‰¹é‡ç”Ÿæˆ</span>
                </div>

                <!-- v7.0æ–°ç‰¹æ€§å±•ç¤º -->
                <div class="highlight-box">
                    <div class="highlight-title">ğŸš€ v7.0 æ ¸å¿ƒå‡çº§</div>
                    <ul class="feature-list">
                        <li>è‡ªåŠ¨ç”Ÿæˆå°é¢æ–‡å­—ï¼ˆ15-22å­—ï¼Œæ™ºèƒ½æ”¹å†™ï¼‰</li>
                        <li>åœºæ™¯åŒ–å¼€å¤´ï¼ˆ3ä¸ªå…·ä½“åœºæ™¯ï¼Œå¼ºå…±é¸£ï¼‰</li>
                        <li>ä¸ªäººæ•…äº‹å¼•å…¥ï¼ˆ"æˆ‘ä¹Ÿæ˜¯ä»XXè¿‡æ¥çš„"ï¼‰</li>
                        <li>å®æˆ˜è¯æœ¯åº“ï¼ˆç›´æ¥å¯ç”¨çš„å¯¹è¯æ¨¡æ¿ï¼‰</li>
                        <li>å­—æ•°å‡çº§åˆ°750-850å­—ï¼ˆå¯¹æ ‡åŒè¡Œï¼‰</li>
                        <li>ç©ºè¡Œå®Œç¾ä¿ç•™ï¼ˆç›²æ–‡ç©ºæ ¼æŠ€æœ¯ï¼‰</li>
                    </ul>
                </div>

                <div class="history-bar" id="historyBar">
                    <div class="history-info">
                        ğŸ’¡ ä¸Šæ¬¡è®°å½•ï¼š<span id="lastSavedTime">æ— </span>
                    </div>
                    <button class="btn btn-warning" onclick="recoverLastSession()" style="margin:0; font-size:12px; padding: 8px 15px;">
                        ğŸ“‚ æ¢å¤/ä¸‹è½½ä¸Šæ¬¡è®°å½•
                    </button>
                </div>
                
                <div class="form-group" style="background: #e7f3ff; padding: 15px; border-radius: 8px; border: 1px solid #b3d9ff;">
                    <label style="color: #0066cc;">ğŸ¯ ç¯‡å¹…é€‰æ‹©</label>
                    <select id="contentLength">
                        <option value="standard">ğŸ”µ æ ‡å‡†ç‰ˆ (750-850å­— | v7.0æ¨è)</option>
                        <option value="long">ğŸŸ£ æ·±åº¦ç‰ˆ (950-1050å­— | æ”¶è—ç‡é«˜)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ ã€æ­¥éª¤1ã€‘ç”Ÿæˆçš„åˆ†é…ç»“æœ</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect()">
                    <div class="status hidden" id="fileInfo"></div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="generateBtn" onclick="startGeneration()" disabled>ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                    <button class="btn" style="background: #ff9800; color: white; display: none;" onclick="pauseGeneration()" id="pauseBtn">â¸ï¸ æš‚åœ</button>
                    <button class="btn btn-success hidden" id="manualDownloadBtn" onclick="manualDownloadCurrent()">ğŸ“¥ æ‰‹åŠ¨å¯¼å‡º</button>
                </div>
                
                <div class="progress-container hidden" id="progressContainer">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
                    <div class="log" id="log"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”§ ç®¡ç†å‘˜é¢æ¿</h3>
                <button class="close-btn" onclick="closeAdminModal()">Ã—</button>
            </div>
            <div id="adminLogin">
                <div class="form-group">
                    <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">ç™»å½•</button>
            </div>
            <div id="adminPanel" class="hidden">
                <div class="form-group">
                    <label>ä¸šåŠ¡çº¿</label>
                    <select id="businessType"><option value="all">å…¨åŠŸèƒ½ç‰ˆ</option></select>
                </div>
                <div class="form-group">
                    <label>åˆ°æœŸæ—¥æœŸ</label>
                    <input type="date" id="expireDate">
                </div>
                <button class="btn btn-success" onclick="generateCode()">ç”Ÿæˆæ¿€æ´»ç </button>
                <div class="code-display hidden" id="codeDisplay">
                    <div class="code-text" id="generatedCode"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            SECRET_KEY: "xiaohongshu_2025_secret_key_change_me",
            ADMIN_PASSWORD: "admin", 
            API_BASE_URL: "https://api.gptsapi.net/v1/chat/completions",
            MODEL: "claude-3-5-sonnet-20240620", 
            
            SENSITIVE_WORDS: {
                'å¾®ä¿¡': 'å¹³æ—¶èŠå¤©', 'åŠ å¾®ä¿¡': 'åŠ å¥½å‹', 'é’±': 'ç±³', 'èµšé’±': 'æç±³',
                'ç§ä¿¡': 'åå°', 'æŠ€å·§': 'æ–¹æ³•', 'å¸®åŠ©': 'ååŠ©', 'æ²¦ä¸º': 'å˜æˆ',
                'èŒåœº': 'å€¼åœº', 'å…¬å¸': 'å…¬åŒ', 'å•ä½': 'å–®ä½', 'åŒäº‹': 'åŒå£«'
            },
            
            KEYWORDS: {
                'work': ['èŒåœº', 'èŒåœºç”Ÿå­˜æ³•åˆ™', 'èŒåœºå¹²è´§', 'èŒåœºæ€ç»´', 'èŒåœºäººé™…å…³ç³»'],
                'social': ['ç¤¾ä¼šåŒ–', 'äººæƒ…ä¸–æ•…', 'é«˜æƒ…å•†', 'ä¸ºäººå¤„äº‹', 'ç¤¾äº¤æŠ€å·§'],
                'growth': ['ä¸ªäººæˆé•¿', 'æˆé•¿', 'è‡ªæˆ‘æå‡', 'æ€ç»´æå‡', 'è®¤çŸ¥è§‰é†’']
            },

            TEMPLATE_TYPES: ['è§‚å¯Ÿå¼', 'æ•…äº‹å¼', 'æ–¹æ³•å¼'],

            // v7.0: å°é¢æ–‡å­—åŒä¹‰è¯åº“
            SYNONYMS: {
                'å¤ªå°‘': 'ä¸è¶³', 'ä¸å¤Ÿ': 'ä¸è¶³', 'å¤ªä½': 'ä¸è¶³',
                'è¯´ç™½äº†': 'å…¶å®æ˜¯', 'åŸæ¥æ˜¯': 'å…¶å®æ˜¯',
                'æ¥ä¸ä½è¯': 'ä¸ä¼šæ¥è¯', 'æ·å¾„': 'ç§˜è¯€',
                'è®­ç»ƒ': 'ç»ƒä¹ '
            },

            // v7.0: å°é¢æ–‡å­—å›ºå®šè¯æœ¯æ¨¡æ¿
            COVER_TEMPLATES: [
                'å¸Œæœ›å¯¹{pain}çš„å®å®ä¸€äº›å¸®åŠ©ï¼',
                'ç»™{pain}çš„å®å­ä¸€äº›å¸®åŠ©ï¼',
                '{pain}å¿…çœ‹ï¼äººæƒ…ä¸–æ•…æ¯å¤©æ‡‚ä¸€ç‚¹',
                'æƒ³æé«˜{pain}çš„å®å®çœ‹è¿‡æ¥ï¼'
            ],

            ENDING: `\n\nğŸ’¡ è¿™ä»½ã€Šæ™®é€šäººç¤¾ä¼šåŒ–æŒ‡å—ã€‹èƒ½å¸®ä½ ä»€ä¹ˆï¼Ÿ\n\n1ï¸âƒ£ å…¨å¥—å¹²è´§ï¼š20ä¸‡å­— + 67èŠ‚ç³»ç»Ÿè¯¾ï¼Œä¸è®²ç©ºè¯ï¼Œåªæ•™æ–¹æ³•ã€‚\n2ï¸âƒ£ å…¨æ™¯è¦†ç›–ï¼šä»é¥­å±€åº”é…¬åˆ°å€¼åœºæ™‹å‡ï¼Œä»æ‹’ç»å†…è€—åˆ°å‘ä¸Šç¤¾äº¤ã€‚\n3ï¸âƒ£ å®æˆ˜å·¥å…·ï¼šé™„èµ è¶…å…¨æ€ç»´å¯¼å›¾ï¼ˆç”µå­ç‰ˆï¼‰ï¼Œæ‹¿æ¥å°±èƒ½ç”¨ã€‚\n\nğŸ‘¥ è¿™å¥—æŒ‡å—é€‚åˆè°ï¼Ÿ\n\nâœ… ç¤¾æ/å†…å‘è€…ï¼šå®³æ€•ç¤¾äº¤ï¼Œæƒ³æ‘†è„±ç´§å¼ å°´å°¬\nâœ… å€¼åœºè€å®äººï¼šä¸æ‡‚æ‹’ç»ï¼Œæ€»è¢«æ‹¿æï¼Œæƒ³å»ºç«‹è¾¹ç•Œ\nâœ… æ²Ÿé€šå°ç™½ï¼šè¯´è¯ç›´æ¥ç›´å»ï¼Œå¸¸å¾—ç½ªäººï¼Œæƒ³æé«˜æƒ…å•†\n\nâ—ï¸â—ï¸ éœ€è¦çš„å®å­ï¼Œç›´æ¥å»æˆ‘ä¸»é¡µåº—é“ºå¸¦èµ° ğŸ›’ğŸ›’ğŸ›’`
        };

        // ========== å°é¢æ–‡å­—ç”Ÿæˆå‡½æ•° ==========
        function generateCoverText(title) {
            const len = title.length;
            
            // ç­–ç•¥1: æ ‡é¢˜14-20å­—ä¸”å¸å¼•äººï¼Œç›´æ¥ç”¨ï¼ˆ24%ï¼‰
            if (len >= 14 && len <= 20 && isAttractive(title)) {
                return title;
            }
            
            // ç­–ç•¥2: åˆ¤æ–­æ˜¯å¦å¤ªç†è®ºï¼ˆ10%ç”¨å›ºå®šè¯æœ¯ï¼‰
            if (isTheoryTitle(title)) {
                const pain = extractPainPoint(title);
                const template = CONFIG.COVER_TEMPLATES[Math.floor(Math.random() * CONFIG.COVER_TEMPLATES.length)];
                let cover = template.replace('{pain}', pain);
                // ç¡®ä¿ä¸è¶…è¿‡22å­—
                if (cover.length > 22) cover = cover.substring(0, 22);
                return cover;
            }
            
            // ç­–ç•¥3: æ”¹å†™å˜ä½“ï¼ˆ66%ä¸»åŠ›ï¼‰
            return rewriteTitle(title);
        }

        function isAttractive(title) {
            // åˆ¤æ–­æ ‡é¢˜æ˜¯å¦å¸å¼•äºº
            const hooks = ['ä¸ä¼š', 'ä¸ºä»€ä¹ˆ', 'å¦‚ä½•', 'ç§˜è¯€', 'ä½ çŸ¥é“', 'æ„Ÿè§‰', 'å…¶å®'];
            return hooks.some(hook => title.includes(hook));
        }

        function isTheoryTitle(title) {
            const theoryWords = ['æŒ‡å—', 'åŸç†', 'æœ¬è´¨', 'å¾€å¾€', 'æ‰¿æ‹…', 'å½±å“'];
            return theoryWords.some(word => title.includes(word));
        }

        function extractPainPoint(title) {
            // æå–æ ¸å¿ƒç—›ç‚¹
            if (title.includes('ä¸ä¼šæ¥è¯')) return 'ä¸ä¼šæ¥è¯';
            if (title.includes('ç¤¾äº¤')) return 'ç¤¾äº¤ä¸­è¿·èŒ«';
            if (title.includes('ç¤¾ä¼šåŒ–')) return 'ç¤¾ä¼šåŒ–ç¨‹åº¦ä½';
            if (title.includes('ä¸»è§')) return 'æ²¡ä¸»è§';
            if (title.includes('å†…å‘')) return 'å†…å‘ç¤¾æ';
            return 'ç¤¾ä¼šåŒ–ç¨‹åº¦ä½';
        }

        function rewriteTitle(title) {
            let cover = title;
            
            // æ–¹æ³•1: åŒä¹‰è¯æ›¿æ¢ï¼ˆ40%ï¼‰
            if (Math.random() < 0.4) {
                for (const [old, newWord] of Object.entries(CONFIG.SYNONYMS)) {
                    cover = cover.replace(old, newWord);
                }
                // è°ƒæ•´æ ‡ç‚¹
                if (!cover.includes('ï¼') && !cover.includes('ï¼Ÿ')) {
                    cover += 'ï¼';
                }
            }
            // æ–¹æ³•2: è½¬ç–‘é—®å¥ï¼ˆ30%ï¼‰
            else if (Math.random() < 0.7) {
                if (cover.includes('æ˜¯')) {
                    cover = `ä½ çŸ¥é“${cover.split('æ˜¯')[0]}å—ï¼Ÿ`;
                } else {
                    cover = cover + 'ï¼Ÿ';
                }
            }
            // æ–¹æ³•3: æ ‡ç‚¹è°ƒæ•´ï¼ˆ30%ï¼‰
            else {
                // è°ƒæ•´é€—å·ä½ç½®
                cover = cover.replace('ï¼Œ', '').replace('ã€‚', '');
                const mid = Math.floor(cover.length / 2);
                cover = cover.substring(0, mid) + 'ï¼Œ' + cover.substring(mid) + 'ï¼';
            }
            
            // ç¡®ä¿æ ‡é¢˜â‰¤20å­—ï¼Œå°é¢â‰¤22å­—
            if (cover.length > 22) {
                cover = cover.substring(0, 22);
            }
            
            return cover;
        }

        // ========== è¾…åŠ©å‡½æ•° ==========
        function randomPickMultiple(array, count) { 
            return array.sort(() => 0.5 - Math.random()).slice(0, count); 
        }

        function randomPick(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function saveUserApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (!key.startsWith('sk-')) return showStatus('apiStatus', 'âŒ Key æ ¼å¼é”™è¯¯', 'error');
            localStorage.setItem('user_api_key', key);
            showStatus('apiStatus', 'âœ… Key å·²ä¿å­˜', 'success');
            setTimeout(() => { 
                document.getElementById('assignSection').classList.remove('hidden');
                document.getElementById('generateSection').classList.remove('hidden'); 
            }, 500);
        }

        function downloadBlankTemplate() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['æ ‡é¢˜']]), "ç©ºç™½æ¨¡æ¿");
            XLSX.writeFile(wb, 'æ­¥éª¤1_ç©ºç™½æ¨¡æ¿.xlsx');
        }

        function handleAssignFile() {
            const f = document.getElementById('assignFile').files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const results = data.map((r, i) => {
                    const templateType = randomPick(CONFIG.TEMPLATE_TYPES);
                    return {
                        'åºå·': i+1, 
                        'æ ‡é¢˜': r['æ ‡é¢˜'], 
                        'æ¨¡æ¿ç±»å‹': templateType,
                        'é€‰é¢˜': 'ç¤¾ä¼šåŒ–', 
                        'ç”Ÿæˆæ•°é‡': 1 
                    };
                });
                
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(results), "åˆ†é…ç»“æœ");
                XLSX.writeFile(newWb, `åˆ†é…ç»“æœ_${Date.now()}.xlsx`);
                showStatus('assignFileInfo', `âœ… åˆ†é…å®Œæˆï¼å·²ä¸º ${results.length} æ¡æ ‡é¢˜åˆ†é…æ¨¡æ¿ç±»å‹`, 'success');
            };
            reader.readAsArrayBuffer(f);
        }

        // ========== v7.0æ ¸å¿ƒç”Ÿæˆå‡½æ•° ==========
        async function generateSocial(row) {
            const mode = document.getElementById('contentLength').value;
            const templateType = row['æ¨¡æ¿ç±»å‹'] || 'è§‚å¯Ÿå¼';
            
            const ADULT_CONSTRAINT = `
ã€é‡è¦è®¾å®šã€‘
1. **ç›®æ ‡è¯»è€…**ï¼š20-30å²çš„èŒåœºæ–°äººã€å¤§å­¦ç”Ÿã€æˆ–æœ‰ç¤¾äº¤å›°æ‰°çš„æˆå¹´äººã€‚
2. **ä¸¥ç¦åœºæ™¯**ï¼šç»å¯¹ä¸è¦å†™å¹¼å„¿å›­ã€å¸¦å¨ƒã€è€å¸ˆè¡¨æ‰¬ç­‰ä½å¹¼åœºæ™¯ï¼è¯·å†™èŒåœºã€èšä¼šã€é¥­å±€ã€‚
3. **è¯­æ°”é£æ ¼**ï¼šæˆç†Ÿã€çŸ¥æ€§ã€æ¸…é†’çš„èŒåœº/ç¤¾äº¤å¯¼å¸ˆã€‚`;

            // v7.0: æ ¹æ®æ¨¡æ¿ç±»å‹é€‰æ‹©ä¸åŒçš„Prompt
            let templatePrompt = '';
            
            if (templateType === 'è§‚å¯Ÿå¼') {
                templatePrompt = mode === 'long' 
                    ? `ã€è§‚å¯Ÿå¼-æ·±åº¦ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ120å­—ï¼‰+ ä¸ªäººç»å†ï¼ˆ80å­—ï¼‰+ 3ä¸ªè§‚å¯Ÿåˆ†æ[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šä¸ºä»€ä¹ˆ40å­—+å…·ä½“åšæ³•å«è¯æœ¯80å­—+ä¾‹å­30å­—ï¼‰ã€‚æ€»å­—æ•°950-1050å­—ã€‚`
                    : `ã€è§‚å¯Ÿå¼-æ ‡å‡†ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ100å­—ï¼Œ3ä¸ªå…·ä½“åœºæ™¯ï¼‰+ ä¸ªäººç»å†ï¼ˆ80å­—ï¼‰+ 3ä¸ªè§‚å¯Ÿè¦ç‚¹[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šä¸ºä»€ä¹ˆ30å­—+å…·ä½“åšæ³•å«è¯æœ¯60å­—+ä¾‹å­25å­—ï¼‰ã€‚æ€»å­—æ•°750-850å­—ã€‚`;
            } else if (templateType === 'æ•…äº‹å¼') {
                templatePrompt = mode === 'long'
                    ? `ã€æ•…äº‹å¼-æ·±åº¦ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ120å­—ï¼‰+ ä¸ªäººæ•…äº‹ï¼ˆ100å­—ï¼‰+ 3ä¸ªè½¬æŠ˜/é˜¶æ®µ[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šèƒŒæ™¯40å­—+å…·ä½“åšæ³•å«è¯æœ¯80å­—+ç»“æœ30å­—ï¼‰ã€‚æ€»å­—æ•°950-1050å­—ã€‚`
                    : `ã€æ•…äº‹å¼-æ ‡å‡†ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ100å­—ï¼Œ3ä¸ªå…·ä½“åœºæ™¯ï¼‰+ ä¸ªäººæ•…äº‹ï¼ˆ80å­—ï¼‰+ 3ä¸ªå…³é”®ç‚¹[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šèƒŒæ™¯30å­—+å…·ä½“åšæ³•å«è¯æœ¯60å­—+ç»“æœ25å­—ï¼‰ã€‚æ€»å­—æ•°750-850å­—ã€‚`;
            } else {
                templatePrompt = mode === 'long'
                    ? `ã€æ–¹æ³•å¼-æ·±åº¦ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ120å­—ï¼‰+ ä¸ºä»€ä¹ˆéœ€è¦ï¼ˆ80å­—ï¼‰+ 3ä¸ªæ–¹æ³•[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šåŸç†40å­—+æ­¥éª¤å«å…·ä½“è¯æœ¯80å­—+æ•ˆæœ30å­—ï¼‰ã€‚æ€»å­—æ•°950-1050å­—ã€‚`
                    : `ã€æ–¹æ³•å¼-æ ‡å‡†ã€‘ç»“æ„ï¼šåœºæ™¯åŒ–å¼€å¤´ï¼ˆ100å­—ï¼Œ3ä¸ªå…·ä½“åœºæ™¯ï¼Œå¦‚ï¼š"æ˜¯ä¸æ˜¯ç»å¸¸è¿™æ ·ï¼šâ€¢åœºæ™¯1â€¢åœºæ™¯2â€¢åœºæ™¯3"ï¼‰+ ä¸ºä»€ä¹ˆéœ€è¦ï¼ˆ80å­—ï¼Œå¦‚"æˆ‘ä¹Ÿæ˜¯ä»XXè¿‡æ¥çš„..."ï¼‰+ 3ä¸ªæ–¹æ³•[ä¸€R][äºŒR][ä¸‰R]ï¼ˆæ¯ä¸ªåŒ…å«ï¼šåŸç†30å­—+æ­¥éª¤å«å…·ä½“è¯æœ¯å¦‚"é”™è¯¯ç¤ºèŒƒï¼šXX æ­£ç¡®è¯æœ¯ï¼šXX"60å­—+æ•ˆæœ25å­—ï¼‰ã€‚æ€»å­—æ•°750-850å­—ã€‚`;
            }

            const finalPrompt = `ä½ æ˜¯ä¸€ä½èŒåœºç¤¾äº¤å¯¼å¸ˆã€‚è¯·ä¸ºæ ‡é¢˜ã€Š${row['æ ‡é¢˜']}ã€‹å†™ä¸€ç¯‡å¹²è´§æ­£æ–‡ï¼ˆä¸è¦ç»“å°¾ï¼‰ã€‚
${ADULT_CONSTRAINT}
${templatePrompt}

ã€å…³é”®è¦æ±‚ã€‘
1. åœºæ™¯åŒ–å¼€å¤´å¿…é¡»å†™3ä¸ªå…·ä½“åœºæ™¯ï¼Œç”¨"æ˜¯ä¸æ˜¯ç»å¸¸è¿™æ ·ï¼š"å¼€å¤´
2. ä¸ªäººç»å†å¿…é¡»åŒ…å«"æˆ‘ä¹Ÿæ˜¯ä»XXè¿‡æ¥çš„"è¿™ç§è¡¨è¿°
3. æ¯ä¸ªè¦ç‚¹å¿…é¡»åŒ…å«å…·ä½“è¯æœ¯ï¼Œæ ¼å¼å¦‚ï¼šé”™è¯¯ç¤ºèŒƒï¼š"XX" æ­£ç¡®è¯æœ¯ï¼š"XX"
4. ç¦æ­¢è‹±æ–‡ã€æ•æ„Ÿè¯ã€ä¸è¦å†™ç»“å°¾æ ‡é¢˜ã€‚`;

            const maxTokens = (mode === 'long') ? 2000 : 1500;

            const userKey = localStorage.getItem('user_api_key');
            const response = await fetch(CONFIG.API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userKey}` },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    messages: [{ role: "user", content: finalPrompt }],
                    temperature: 0.85, 
                    max_tokens: maxTokens
                })
            });
            const data = await response.json();
            let content = data.choices[0].message.content;
            
            // æ¸…ç†æ ¼å¼
            let body = content.replace(/\*\*/g, "").replace(/\b[A-Za-z]{2,}\b/g, ""); 
            body = body.replace(/\[1\]/g, "[ä¸€R]").replace(/\[2\]/g, "[äºŒR]").replace(/\[3\]/g, "[ä¸‰R]");
            body = body.replace(/([^\n])\[([ä¸€äºŒä¸‰]R)\]/g, "$1\n\n[$2]");
            
            // ç§»é™¤å¯èƒ½çš„æ ‡é¢˜è¡Œ
            const lines = body.split('\n');
            if (lines.length > 0) {
                const firstLine = lines[0].trim();
                if (firstLine.includes('æ ‡é¢˜ï¼š') || firstLine.includes('å°çº¢ä¹¦æ ‡é¢˜') || firstLine === row['æ ‡é¢˜']) {
                    lines.shift();
                    if (lines.length > 0 && (lines[0].trim().includes('æ­£æ–‡ï¼š') || lines[0].trim() === 'æ­£æ–‡')) lines.shift();
                    body = lines.join('\n').trim();
                }
            }

            let full = body + CONFIG.ENDING;
            
            // æ•æ„Ÿè¯è¿‡æ»¤
            for (const [key, val] of Object.entries(CONFIG.SENSITIVE_WORDS)) {
                full = full.replace(new RegExp(key, 'g'), val);
            }
            
            // v7.0: ä½¿ç”¨ç›²æ–‡ç©ºæ ¼ä½œä¸ºç©ºè¡Œå ä½ç¬¦
            full = full.replace(/\n\n/g, '\nâ €\n');
            
            // ç”Ÿæˆæ ‡ç­¾
            let tags = ['#æ™®é€šäººç¤¾ä¼šåŒ–æŒ‡å—', '#äººæƒ…ä¸–æ•…'];
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.work, 3).map(t=>'#'+t));
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.social, 3).map(t=>'#'+t));
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.growth, 2).map(t=>'#'+t));
            
            // v7.0: ç”Ÿæˆå°é¢æ–‡å­—
            let coverText = generateCoverText(row['æ ‡é¢˜']);
            
            // ç¡®ä¿æ ‡é¢˜â‰¤20å­—
            let finalTitle = row['æ ‡é¢˜'];
            if (finalTitle.length > 20) {
                finalTitle = finalTitle.substring(0, 20);
            }
            
            return { 
                title: finalTitle,
                coverText: coverText,
                templateType: templateType,
                body: full, 
                tags: tags.slice(0,10).join(' ') 
            };
        }

        // ========== æµç¨‹æ§åˆ¶ & å†å²è®°å½• ==========
        let excelData = null;
        let isPaused = false;
        let pauseRequested = false;
        let currentResults = [];

        function saveToHistory(results) {
            try {
                const now = new Date().toLocaleString();
                localStorage.setItem('xhs_last_results', JSON.stringify(results));
                localStorage.setItem('xhs_last_time', now);
                document.getElementById('lastSavedTime').textContent = now;
            } catch (e) {
                console.warn("å­˜å‚¨ç©ºé—´ä¸è¶³", e);
            }
        }

        function recoverLastSession() {
            const stored = localStorage.getItem('xhs_last_results');
            if (!stored) { alert("æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•ï¼"); return; }
            const results = JSON.parse(stored);
            if (results.length === 0) { alert("å†å²è®°å½•ä¸ºç©º"); return; }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(results), "æ¢å¤çš„å†å²è®°å½•");
            XLSX.writeFile(wb, `å†å²è®°å½•æ¢å¤_${Date.now()}.xlsx`);
            alert(`å·²æˆåŠŸæ¢å¤å¹¶ä¸‹è½½ ${results.length} æ¡è®°å½•`);
        }
        
        function manualDownloadCurrent() {
            if (currentResults.length === 0) { alert("å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹"); return; }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentResults), "æ‰‹åŠ¨å¯¼å‡º");
            XLSX.writeFile(wb, `æ‰‹åŠ¨å¯¼å‡ºè¿›åº¦_${Date.now()}.xlsx`);
        }

        function handleFileSelect() {
            const f = document.getElementById('excelFile').files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (!excelData[0]['æ ‡é¢˜']) {
                    showStatus('fileInfo', 'âŒ é”™è¯¯ï¼šè¯·ä¸Šä¼ å«ã€æ ‡é¢˜ã€‘åˆ—çš„Excel', 'error');
                } else {
                    showStatus('fileInfo', `âœ… å·²åŠ è½½ ${excelData.length} æ¡ä»»åŠ¡`, 'success');
                    document.getElementById('generateBtn').disabled = false;
                }
            };
            reader.readAsArrayBuffer(f);
        }

        async function startGeneration() {
            const userKey = localStorage.getItem('user_api_key');
            if (!userKey) { alert("è¯·å…ˆé…ç½®Key"); return; }
            
            isPaused = false;
            pauseRequested = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('manualDownloadBtn').classList.remove('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            const log = document.getElementById('log'); log.innerHTML = '';
            
            currentResults = [];
            const total = excelData.length;

            for (let i = 0; i < total; i++) {
                if (pauseRequested) {
                    isPaused = true;
                    manualDownloadCurrent();
                    log.innerHTML += `<div class="log-item" style="background:#fff3cd; color:#856404; font-weight:bold;">â¸ï¸ ä»»åŠ¡æš‚åœï¼Œå·²å¯¼å‡ºå½“å‰è¿›åº¦</div>`;
                    log.scrollTop = log.scrollHeight;
                    document.getElementById('pauseBtn').innerText = "â–¶ï¸ ç»§ç»­";
                    return; 
                }

                const row = excelData[i];
                if (!row['æ ‡é¢˜']) continue;

                log.innerHTML += `<div class="log-item">[${i+1}/${total}] ${row['æ¨¡æ¿ç±»å‹'] || 'è§‚å¯Ÿå¼'} | ${row['æ ‡é¢˜']}...</div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    let res = await generateSocial(row);
                    const newRow = {
                        'åºå·': i+1,
                        'æ ‡é¢˜': res.title,
                        'å°é¢æ–‡å­—': res.coverText,  // v7.0æ–°å¢
                        'æ¨¡æ¿ç±»å‹': res.templateType,
                        'ç”Ÿæˆæ–‡æ¡ˆ': res.body, 
                        'è¯é¢˜': res.tags, 
                        'å­—æ•°': res.body.replace(/â €/g, '').length
                    };
                    currentResults.push(newRow);
                    
                    saveToHistory(currentResults);

                    log.innerHTML += `<div class="log-item" style="color: green; font-weight: bold;">âœ… æˆåŠŸ (${newRow['å­—æ•°']}å­—) | å°é¢: ${res.coverText}</div>`;
                    document.getElementById('progressFill').style.width = ((i+1)/total*100) + '%';
                    document.getElementById('progressFill').textContent = Math.round((i+1)/total*100) + '%';
                } catch (e) {
                    console.error(e);
                    log.innerHTML += `<div class="log-item" style="color:red; font-weight:bold;">âŒ å¤±è´¥: ${e.message}</div>`;
                }
                
                await new Promise(r => setTimeout(r, 1000));
            }

            manualDownloadCurrent();
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('manualDownloadBtn').classList.add('hidden');
            log.innerHTML += `<div class="log-item" style="background:#d4edda; color:#155724; padding:10px;">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
        }

        function pauseGeneration() { 
            if(isPaused) { 
                isPaused = false;
                pauseRequested = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ";
                startGeneration(); 
            } else {
                pauseRequested = true; 
            }
        }

        // ========== æ¿€æ´»ç é€»è¾‘ ==========
        function generateActivationCode(businessType, expireDate) {
            const dateStr = expireDate.replace(/-/g, '');
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            const check = CryptoJS.MD5(businessType.toUpperCase() + dateStr + CONFIG.SECRET_KEY).toString().substring(0, 4).toUpperCase();
            return `XHS-${businessType.toUpperCase()}-${dateStr}-${random}-${check}`;
        }

        function validateActivationCode(code) {
            try {
                const parts = code.trim().toUpperCase().split('-');
                if (parts.length !== 5 || parts[0] !== 'XHS') return { valid: false, msg: "æ ¼å¼é”™è¯¯" };
                const [_, business, dateStr, random, check] = parts;
                const expectedCheck = CryptoJS.MD5(business + dateStr + CONFIG.SECRET_KEY).toString().substring(0, 4).toUpperCase();
                if (check !== expectedCheck) return { valid: false, msg: "æ ¡éªŒå¤±è´¥" };
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                if (new Date() > new Date(year, month, day + 1)) return { valid: false, msg: "æ¿€æ´»ç å·²è¿‡æœŸ" };
                return { valid: true, business: business, expireDate: `${year}-${month+1}-${day}`, msg: "æ¿€æ´»æˆåŠŸ" };
            } catch (e) { return { valid: false, msg: "æ— æ•ˆæ¿€æ´»ç " }; }
        }

        function activate() {
            const code = document.getElementById('activationCode').value;
            const result = validateActivationCode(code);
            const status = document.getElementById('activationStatus');
            
            if (result.valid) {
                localStorage.setItem('activation', JSON.stringify({
                    code: code, business: result.business, expireDate: result.expireDate
                }));
                showStatus(status, 'âœ… æ¿€æ´»æˆåŠŸ', 'success');
                setTimeout(() => {
                    document.getElementById('activationSection').classList.add('hidden');
                    document.getElementById('activatedInfo').classList.remove('hidden');
                    document.getElementById('apiConfigSection').classList.remove('hidden');
                    document.getElementById('businessInfo').textContent = result.business;
                    document.getElementById('expireInfo').textContent = result.expireDate;
                }, 1000);
            } else {
                showStatus(status, 'âŒ ' + result.msg, 'error');
            }
        }

        function resetActivation() {
            localStorage.removeItem('activation');
            localStorage.removeItem('user_api_key');
            location.reload();
        }

        function showAdminModal() { document.getElementById('adminModal').classList.add('show'); }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('show'); }
        function showStatus(id, msg, type) { 
            const el = typeof id === 'string' ? document.getElementById(id) : id;
            el.textContent = msg; 
            el.className = `status ${type}`; 
            el.classList.remove('hidden'); 
        }
        
        function adminLogin() { 
            if(document.getElementById('adminPassword').value === CONFIG.ADMIN_PASSWORD) { 
                document.getElementById('adminLogin').classList.add('hidden'); 
                document.getElementById('adminPanel').classList.remove('hidden'); 
            } else {
                alert('å¯†ç é”™è¯¯'); 
            }
        }
        
        function generateCode() { 
            const date = document.getElementById('expireDate').value; 
            if(!date) return alert('é€‰æ—¥æœŸ'); 
            const code = generateActivationCode('all', date); 
            document.getElementById('generatedCode').textContent = code; 
            document.getElementById('codeDisplay').classList.remove('hidden'); 
        }
        
        window.onload = function() {
            const lastTime = localStorage.getItem('xhs_last_time');
            if (lastTime) { document.getElementById('lastSavedTime').textContent = lastTime; }

            const act = JSON.parse(localStorage.getItem('activation'));
            const key = localStorage.getItem('user_api_key');
            if (act) {
                document.getElementById('activationSection').classList.add('hidden');
                document.getElementById('activatedInfo').classList.remove('hidden');
                document.getElementById('apiConfigSection').classList.remove('hidden');
                document.getElementById('businessInfo').textContent = act.business;
                document.getElementById('expireInfo').textContent = act.expireDate;
                if (key) { 
                    document.getElementById('userApiKey').value = key; 
                    document.getElementById('assignSection').classList.remove('hidden');
                    document.getElementById('generateSection').classList.remove('hidden'); 
                }
            }
        };
    </script>
</body>
</html>
