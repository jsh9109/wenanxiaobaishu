<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOå†…å®¹çŸ©é˜µç”Ÿæˆç³»ç»Ÿ - v6.1 æœ€ç»ˆäº¤ä»˜ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* v6.1 é£æ ¼ - çš‡å®¶è“ - ç¨³å®šä¸ä¸“ä¸š */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: #003eb3; color: white; padding: 25px; text-align: center; position: relative; }
        .header h1 { font-size: 24px; margin-bottom: 5px; font-weight: 600; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .top-bar { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
        .history-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .history-btn:hover { background: rgba(255,255,255,0.3); }

        .content { padding: 30px; }
        .section { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #d6e4ff; border-left: 5px solid #003eb3; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .info-box { background: #f0f5ff; border: 1px solid #adc6ff; color: #003eb3; padding: 12px; border-radius: 6px; font-size: 13px; margin-bottom: 15px; }
        
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; margin-right: 10px; transition: 0.2s; }
        .btn-blue { background: #003eb3; }
        .btn-green { background: #389e0d; }
        .btn-orange { background: #d46b08; }
        .log { margin-top: 15px; padding: 15px; background: #1f1f1f; color: #00ff00; border-radius: 6px; max-height: 300px; overflow-y: auto; font-family: "Menlo", monospace; font-size: 12px; border: 1px solid #333; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d9d9d9; border-radius: 6px; }
        .input-group { display: flex; gap: 10px; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .history-list { list-style: none; padding: 0; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ æˆ’æŒ‡SEOå†…å®¹å·¥å‚ v6.1 (æœ€ç»ˆç‰ˆ)</h1>
            <p>100%è°ƒç”¨æ‚¨çš„Excelçˆ†æ¬¾åº“ | æ‹’ç»é‡å¤ | æ ¼å¼å®Œç¾</p>
            <div class="top-bar">
                <button class="history-btn" onclick="showHistoryModal()">ğŸ“œ æŸ¥çœ‹å†å²è®°å½•</button>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“¥ æ­¥éª¤ 0ï¼šæ¨¡æ¿å‡†å¤‡</div>
                <div class="info-box">
                    ğŸ“Š <b>é€»è¾‘ç¡®è®¤ï¼š</b><br>
                    ç³»ç»Ÿå°†è¯»å–æ‚¨è¡¨æ ¼ä¸­çš„ <b>[ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“]</b>ã€‚<br>
                    ç”Ÿæˆæ¯ä¸€æ¡æ–‡æ¡ˆæ—¶ï¼Œéƒ½ä¼š<b>éšæœºæŠ½å–</b>ä¸€ä¸ªæ ‡é¢˜è®©AIè¿›è¡Œæ·±åº¦ä»¿å†™ã€‚<br>
                    (è¯·ç¡®ä¿æ‚¨çš„ Excel é‡Œæœ‰è¿™ä¸ªè¡¨ï¼Œå†…å®¹è¶Šå¤šè¶Šå¥½ï¼)
                </div>
                <button class="btn btn-blue" onclick="downloadSmartTemplate()">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿_v5.4.xlsx</button>
            </div>

            <div class="section">
                <div class="section-title">ğŸ”Œ æ­¥éª¤ 1ï¼šé…ç½® API</div>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                    <button class="btn btn-green" onclick="saveApiKey()" style="margin-right:0;">ğŸ’¾ ä¿å­˜ Key</button>
                </div>
                <div id="keyStatus" style="font-size:12px; color:green; margin-top:5px; height:18px;"></div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“‚ æ­¥éª¤ 2ï¼šä¸Šä¼ æ‚¨çš„è¡¨æ ¼</div>
                <input type="file" id="systemFile" accept=".xlsx,.xls" onchange="handleSystemFile()">
                <div id="fileStatus" class="hidden" style="margin-top:10px; color:#003eb3; font-weight:bold;"></div>
            </div>

            <div class="section hidden" id="configSection">
                <div class="section-title">âš™ï¸ æ­¥éª¤ 3ï¼šæ‰§è¡Œç”Ÿäº§</div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; font-size:12px; color:#666;">è¯·é€‰æ‹©æŒ‡ä»¤ï¼ˆå»ºè®®ä½¿ç”¨ä¿®æ­£çˆ†æ¬¾æ¨¡å¼ï¼‰ï¼š</label>
                    <select id="promptTemplate"><option value="">-- è¯·é€‰æ‹© --</option></select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-blue" id="startBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿäº§</button>
                    <button class="btn btn-orange hidden" id="pauseBtn" onclick="togglePause()">â¸ï¸ æš‚åœ</button>
                    <button class="btn btn-green hidden" id="downloadBtn" onclick="downloadResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                </div>
                
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ’¾ æœ€è¿‘ 5 æ¬¡è®°å½•</h3>
            <ul class="history-list" id="historyListUi"></ul>
            <button class="btn btn-blue" onclick="document.getElementById('historyModal').style.display='none'" style="width:100%; margin-top:15px;">å…³é—­</button>
        </div>
    </div>

    <script>
        const SHEET_NAMES = { keywords: "ğŸ”SEOå…³é”®è¯åº“", prompts: "ğŸ¤–AIç”ŸæˆæŒ‡ä»¤", tags: "ğŸ·ï¸è¯é¢˜æ ‡ç­¾SEOåº“", titles: "ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“" };
        let GLOBAL_DATA = { keywords: [], prompts: [], tags: [], titles: [], generated: [] };
        let isPaused = false;

        // --- 1. Key è®°å¿†åŠŸèƒ½ ---
        window.onload = function() {
            const savedKey = localStorage.getItem('xhs_user_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('keyStatus').textContent = "âœ… Key å·²è‡ªåŠ¨åŠ è½½";
            }
        };
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return alert("è¯·è¾“å…¥ Key");
            localStorage.setItem('xhs_user_api_key', key);
            document.getElementById('keyStatus').textContent = "âœ… Key å·²ä¿å­˜";
        }

        // --- 2. å†å²è®°å½•åŠŸèƒ½ ---
        function saveToHistoryList(data) {
            if (!data || data.length === 0) return;
            let history = JSON.parse(localStorage.getItem('xhs_history_list_v6') || "[]");
            const record = { id: new Date().getTime(), time: new Date().toLocaleString(), count: data.length, data: data };
            history.unshift(record);
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('xhs_history_list_v6', JSON.stringify(history));
        }

        function showHistoryModal() {
            const history = JSON.parse(localStorage.getItem('xhs_history_list_v6') || "[]");
            const ui = document.getElementById('historyListUi');
            ui.innerHTML = "";
            if(history.length === 0) ui.innerHTML = "<li style='color:#999;text-align:center;padding:20px;'>æš‚æ— è®°å½•</li>";
            history.forEach((rec) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `<div><b>${rec.time}</b> <br><span style="font-size:12px;color:#666;">å…± ${rec.count} æ¡</span></div> <span style="color:#003eb3;font-weight:bold;">ä¸‹è½½</span>`;
                li.onclick = () => { exportExcel(rec.data, `å†å²æ¢å¤_${rec.id}.xlsx`); document.getElementById('historyModal').style.display = 'none'; };
                ui.appendChild(li);
            });
            document.getElementById('historyModal').style.display = 'flex';
        }

        function exportExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿæˆç»“æœ");
            XLSX.writeFile(wb, filename);
        }

        // --- 3. æ¨¡æ¿ä¸‹è½½ (å«ä¿®æ­£æŒ‡ä»¤) ---
        function downloadSmartTemplate() {
            const wb = XLSX.utils.book_new();
            const wsKw = XLSX.utils.aoa_to_sheet([["å…³é”®è¯", "ä¼˜å…ˆçº§", "ä»·æ ¼", "æè´¨", "å¤‡æ³¨"], ["æ°´æ³¢çº¹æˆ’æŒ‡", "â­â­â­", "13.9", "é“¶è‰²è´¨æ„Ÿ", "ç¤ºä¾‹"]]);
            XLSX.utils.book_append_sheet(wb, wsKw, SHEET_NAMES.keywords);
            
            const promptsData = [["æŒ‡ä»¤åç§°", "æŒ‡ä»¤å†…å®¹"], ["æŒ‡ä»¤1ï¼šçˆ†æ¬¾ä¿®æ­£æ¨¡å¼", `ã€è§’è‰²è®¾å®šã€‘\næ¿€åŠ¨å¾—è¯­æ— ä¼¦æ¬¡çš„å¥³ç”Ÿã€‚\nã€æ ¸å¿ƒå…³é”®è¯ã€‘{ä»SEOå…³é”®è¯åº“é€‰æ‹©}\nã€æ ‡é¢˜è¦æ±‚ã€‘è¯·æ¨¡ä»¿æˆ‘æä¾›çš„ã€å‚è€ƒæ ‡é¢˜ã€‘å¥å¼ï¼\nã€æ­£æ–‡è¦æ±‚ã€‘æ¯ä¸€å¥è¯éƒ½è¦æ¢è¡Œï¼ä¸è¦ç”¨é€—å·ã€‚å¿…é¡»åŒ…å«åœºæ™¯ã€ç—›ç‚¹ã€ç»†èŠ‚ã€é€¼å•ã€‚\nè¯·è¾“å‡ºï¼š\næ ‡é¢˜\næ­£æ–‡`]];
            const wsPrompt = XLSX.utils.aoa_to_sheet(promptsData);
            XLSX.utils.book_append_sheet(wb, wsPrompt, SHEET_NAMES.prompts);

            const wsTags = XLSX.utils.aoa_to_sheet([["æ ‡ç­¾å†…å®¹", "æ ‡ç­¾ç±»å‹"], ["#æˆ’æŒ‡", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"]]);
            XLSX.utils.book_append_sheet(wb, wsTags, SHEET_NAMES.tags);
            
            // é¢„ç½®ä¸€äº›æ ‡é¢˜é˜²ç©º
            const wsTitles = XLSX.utils.aoa_to_sheet([["çˆ†æ¬¾æ ‡é¢˜å†…å®¹"], ["åŒäº‹ï¼šä½ è¿™æˆ’æŒ‡å¤§ç‰Œå§ï¼Ÿæˆ‘ï¼š13.9ï¼"], ["æ•‘å‘½ğŸ†˜é—ºèœœéæŠ¢æˆ‘æ‰‹ä¸Šçš„æˆ’æŒ‡ï¼"], ["åˆæ˜¯è¢«é™Œç”Ÿäººå¤¸æˆ’æŒ‡å¥½çœ‹çš„ä¸€å¤©ğŸ˜­"], ["è¢«ç”·å‹å¤¸äº†ï¼è¯´è¿™é“¶è‰²è´¨æ„Ÿç»äº†"]]);
            XLSX.utils.book_append_sheet(wb, wsTitles, SHEET_NAMES.titles);
            
            XLSX.writeFile(wb, "æ ‡å‡†å¡«ç©ºæ¨¡æ¿_v5.4.xlsx");
        }

        // --- 4. æ–‡ä»¶è¯»å– (æ ¸å¿ƒï¼šè¯»å– Titles) ---
        function handleSystemFile() {
            const file = document.getElementById('systemFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const findSheet = (name) => workbook.SheetNames.find(n => n.includes(name.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, "")));
                    
                    let s1 = workbook.Sheets[SHEET_NAMES.keywords] || workbook.Sheets[findSheet("SEOå…³é”®è¯åº“")];
                    let s2 = workbook.Sheets[SHEET_NAMES.prompts] || workbook.Sheets[findSheet("AIç”ŸæˆæŒ‡ä»¤")];
                    let s3 = workbook.Sheets[SHEET_NAMES.tags] || workbook.Sheets[findSheet("è¯é¢˜æ ‡ç­¾SEOåº“")];
                    // ğŸ”¥ è¯»å–çˆ†æ¬¾åº“
                    let s4 = workbook.Sheets[SHEET_NAMES.titles] || workbook.Sheets[findSheet("çˆ†æ¬¾æ ‡é¢˜åº“")];

                    if(s1) GLOBAL_DATA.keywords = XLSX.utils.sheet_to_json(s1);
                    if(s2) GLOBAL_DATA.prompts = XLSX.utils.sheet_to_json(s2);
                    if(s3) GLOBAL_DATA.tags = XLSX.utils.sheet_to_json(s3);
                    
                    if(s4) {
                        const raw = XLSX.utils.sheet_to_json(s4, {header: 1}); 
                        GLOBAL_DATA.titles = raw.flat().filter(t => t && t !== "çˆ†æ¬¾æ ‡é¢˜å†…å®¹" && t.toString().length > 4);
                    } else {
                        GLOBAL_DATA.titles = [];
                    }

                    if (!s1 || !s2) return alert("âŒ è¡¨æ ¼ç¼ºå°‘å¿…è¦çš„Sheetï¼Œè¯·æ£€æŸ¥ï¼");
                    
                    document.getElementById('fileStatus').innerHTML = `âœ… äº§å“: ${GLOBAL_DATA.keywords.length}ä¸ª | ğŸ”¥ çˆ†æ¬¾åº“: ${GLOBAL_DATA.titles.length}æ¡ (å°†éšæœºè°ƒç”¨)`;
                    document.getElementById('fileStatus').classList.remove('hidden');
                    
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    GLOBAL_DATA.prompts.forEach((row, i) => { if(row['æŒ‡ä»¤åç§°']) select.innerHTML += `<option value="${i}">${row['æŒ‡ä»¤åç§°']}</option>`; });
                    document.getElementById('configSection').classList.remove('hidden');
                } catch (err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        }

        function getTags() {
            if(!GLOBAL_DATA.tags || !GLOBAL_DATA.tags.length) return "#æ¨è";
            const fixed = GLOBAL_DATA.tags.filter(t => t['æ ‡ç­¾ç±»å‹'] && t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            const others = GLOBAL_DATA.tags.filter(t => !t['æ ‡ç­¾ç±»å‹'] || !t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            return [...fixed, ...others.sort(() => 0.5 - Math.random()).slice(0, 7)].join(" ");
        }

        // --- 5. æš‚åœä¸ä¸‹è½½ ---
        function togglePause() {
            if (isPaused) {
                isPaused = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ";
                document.getElementById('pauseBtn').className = "btn btn-orange";
            } else {
                isPaused = true;
                document.getElementById('pauseBtn').innerText = "â–¶ï¸ ç»§ç»­";
                document.getElementById('pauseBtn').className = "btn btn-green";
                saveToHistoryList(GLOBAL_DATA.generated);
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        function downloadResult() {
            if (!GLOBAL_DATA.generated || GLOBAL_DATA.generated.length === 0) return alert("æ— æ•°æ®");
            const now = new Date();
            const timeStr = `${now.getHours()}${now.getMinutes()}`;
            exportExcel(GLOBAL_DATA.generated, `ç”Ÿæˆç»“æœ_${timeStr}.xlsx`);
            saveToHistoryList(GLOBAL_DATA.generated);
        }

        // --- 6. æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (v6.1) ---
        async function startGeneration() {
            let apiKey = document.getElementById('apiKey').value;
            if (!apiKey) apiKey = localStorage.getItem('xhs_user_api_key');
            
            const pIdx = document.getElementById('promptTemplate').value;
            if(!apiKey || pIdx === "") return alert("è¯·é…ç½®APIå’ŒæŒ‡ä»¤");

            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            
            isPaused = false; 
            
            const promptRow = GLOBAL_DATA.prompts[pIdx];
            let originalTemplate = promptRow['æŒ‡ä»¤å†…å®¹'];
            
            const log = document.getElementById('log');
            GLOBAL_DATA.generated = [];
            const tasks = GLOBAL_DATA.keywords;

            for(let i=0; i<tasks.length; i++) {
                while(isPaused) { await new Promise(r => setTimeout(r, 500)); }

                const row = tasks[i];
                const kw = row['å…³é”®è¯'];
                if(!kw) continue;

                let finalPrompt = originalTemplate;
                // å˜é‡æ›¿æ¢
                finalPrompt = finalPrompt.replace(/\{ä»SEOå…³é”®è¯åº“é€‰æ‹©\}/g, kw).replace(/\{å…³é”®è¯\}/g, kw);
                const price = row['ä»·æ ¼'] || "13.9"; 
                finalPrompt = finalPrompt.replace(/\{ä»·æ ¼\}/g, price);
                const material = row['æè´¨'] || "é“¶è‰²è´¨æ„Ÿ";
                finalPrompt = finalPrompt.replace(/\{æè´¨\}/g, material);
                
                // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šä» Excel åº“ä¸­éšæœºæŠ½ä¸€ä¸ªæ ‡é¢˜
                let randomRefTitle = "åŒäº‹ï¼šè¿™æˆ’æŒ‡å¤§ç‰Œå§ï¼Ÿæˆ‘ï¼š13.9ï¼"; // é»˜è®¤å…œåº•
                if (GLOBAL_DATA.titles && GLOBAL_DATA.titles.length > 0) {
                    const rIdx = Math.floor(Math.random() * GLOBAL_DATA.titles.length);
                    randomRefTitle = GLOBAL_DATA.titles[rIdx];
                }
                
                // ç§»é™¤æ—§ç¤ºä¾‹ï¼Œæ³¨å…¥æ–°è¦æ±‚
                finalPrompt = finalPrompt.replace(/ç¤ºä¾‹ï¼š[\s\S]*?(?=\n\n|\nã€)/, ""); 
                finalPrompt += `\n\nã€âš ï¸æœ¬æ¬¡ä»»åŠ¡æ ¸å¿ƒè¦æ±‚ã€‘\nè¯·åŠ¡å¿…æ¨¡ä»¿ä¸‹é¢è¿™ä¸ªå‚è€ƒæ ‡é¢˜çš„ã€å¥å¼ã€‘ã€ã€è¯­æ°”ã€‘å’Œã€æ ‡ç‚¹ä½¿ç”¨ã€‘ï¼Œä¸è¦ç›´æ¥æŠ„ï¼Œè¦ä»¿å†™ï¼\nå‚è€ƒæ ‡é¢˜ï¼šğŸ‘‰ "${randomRefTitle}"`;
                
                // é”æ­»æ•°æ®
                finalPrompt += `\n\nã€çº¢çº¿ã€‘\n1. ä»·æ ¼å¿…é¡»å†™ï¼š${price}ï¼\n2. å…³é”®è¯ï¼š${kw}ï¼\n3. ä¸è¦Markdownï¼Œä¸è¦å†™å‰ç¼€ã€‚`;

                log.innerHTML += `<div>[${i+1}/${tasks.length}] æ­£åœ¨ç”Ÿæˆ... <br><span style="color:#888;">ä»¿å†™ç›®æ ‡: ${randomRefTitle}</span></div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const res = await fetch("https://api.gptsapi.net/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                        body: JSON.stringify({ model: "gpt-4o", messages: [{role: "user", content: finalPrompt}], temperature: 0.9 }) 
                    });
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    const content = json.choices[0].message.content;
                    
                    // æ¸…æ´—é€»è¾‘
                    const cleanStr = (str) => str.replace(/\*\*/g, '').replace(/###/g, '').replace(/ã€|ã€‘/g, '').trim();
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let title = "";
                    let body = "";

                    if(lines.length > 0) {
                        let candidate = cleanStr(lines[0]);
                        candidate = candidate.replace(/^(æ ‡é¢˜|Title)[:ï¼š]?\s*/i, '');
                        if (candidate === "æ ‡é¢˜" || candidate === "Title") { lines.shift(); if (lines.length > 0) { candidate = cleanStr(lines[0]); lines.shift(); } } else { lines.shift(); }
                        if(candidate.length > 25) candidate = candidate.substring(0, 25); 
                        title = candidate;
                        
                        let rawBody = lines.join('\n'); 
                        body = cleanStr(rawBody);
                        body = body.replace(/^\s*(æ­£æ–‡|Body)[:ï¼š]?\s*/i, '');
                        body = body.replace(/^-+/, '').trim();
                        body = body.replace(/#\S+/g, '').split(/è¯é¢˜æ ‡ç­¾|Tags/i)[0].trim();
                        
                        if (!title || title.length < 2) { const bodyParts = body.split('\n'); if (bodyParts.length > 0) { title = bodyParts[0]; body = bodyParts.slice(1).join('\n'); } }
                        if (!body.includes('\n')) body = body.replace(/([ã€‚ï¼ï¼Ÿ])/g, "$1\n\n");
                    }

                    GLOBAL_DATA.generated.push({
                        "åºå·": i+1,
                        "å…³é”®è¯": kw,
                        "æ ‡é¢˜": title,
                        "æ­£æ–‡": body, 
                        "è¯é¢˜æ ‡ç­¾": getTags(),
                        "å¤‡æ³¨": `ğŸ’°${price} / ğŸ’${material}`
                    });
                    
                } catch(e) { log.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`; }
                await new Promise(r => setTimeout(r, 800));
            }

            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            log.innerHTML += `<div style="color:#0f0">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
            downloadResult();
        }
    </script>
</body>
</html>
