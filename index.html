<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOå†…å®¹çŸ©é˜µç”Ÿæˆç³»ç»Ÿ - v5.3 äº¤äº’å¢å¼ºç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* v5.3 é£æ ¼ - ç°ä»£å•†åŠ¡ç°è“ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; min-height: 100vh; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 25px; text-align: center; position: relative; }
        .header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 500; }
        .header p { opacity: 0.8; font-size: 13px; }
        
        .top-btn { position: absolute; top: 25px; right: 20px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .top-btn:hover { background: rgba(255,255,255,0.25); }

        .content { padding: 30px; }
        .section { background: #fff; border-radius: 6px; padding: 20px; margin-bottom: 20px; border: 1px solid #e1e4e8; border-left: 4px solid #2c3e50; }
        .section-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .info-box { background: #e8f4fd; border: 1px solid #d1eafe; color: #0366d6; padding: 12px; border-radius: 4px; font-size: 13px; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 500; margin-right: 10px; transition: 0.2s; }
        .btn-blue { background: #2c3e50; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        .btn-disabled { background: #ccc; cursor: not-allowed; }

        .log { margin-top: 15px; padding: 15px; background: #f8f9fa; color: #333; border-radius: 4px; max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #eee; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; }
        
        /* å†å²è®°å½•æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 400px; max-width: 90%; }
        .modal h3 { margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .history-list { list-style: none; padding: 0; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { background: #f8f9fa; }
        .history-info { font-size: 13px; color: #555; }
        .history-tag { background: #e1e4e8; color: #333; padding: 2px 6px; border-radius: 10px; font-size: 11px; }
        .close-btn { float: right; cursor: pointer; font-size: 20px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="top-btn" onclick="showHistoryModal()">ğŸ“œ å†å²è®°å½• (æœ€è¿‘5æ¡)</button>
            <h1>ğŸ’ æˆ’æŒ‡SEOå†…å®¹å·¥å‚ v5.3</h1>
            <p>æš‚åœå¯¼å‡º | å¤šæ¡å†å² | ä¸¥æ ¼æŒ‡ä»¤</p>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“¥ æ­¥éª¤ 0ï¼šæ¨¡æ¿å‡†å¤‡</div>
                <div class="info-box">
                    ğŸ’¡ <b>åŠŸèƒ½æç¤ºï¼š</b><br>
                    1. <b>æš‚åœå¯å¯¼å‡º</b>ï¼šç”Ÿæˆä¸€åŠæƒ³åœï¼Ÿç‚¹å‡»æš‚åœï¼Œç›´æ¥å¯¼å‡ºå½“å‰è¿›åº¦ã€‚<br>
                    2. <b>å†å²å›æº¯</b>ï¼šç‚¹å‡»å³ä¸Šè§’â€œå†å²è®°å½•â€ï¼Œæ‰¾å›æœ€è¿‘ 5 æ¬¡çš„ä»»åŠ¡ç»“æœã€‚
                </div>
                <button class="btn btn-blue" onclick="downloadSmartTemplate()">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿_v4.0ç»“æ„.xlsx</button>
            </div>

            <div class="section">
                <div class="section-title">ğŸ”Œ æ­¥éª¤ 1ï¼šé…ç½® API (è‡ªåŠ¨è®°å¿†)</div>
                <div style="display:flex; gap:10px;">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                    <button class="btn btn-green" onclick="saveApiKey()" style="margin-right:0;">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“‚ æ­¥éª¤ 2ï¼šä¸Šä¼ è¡¨æ ¼</div>
                <input type="file" id="systemFile" accept=".xlsx,.xls" onchange="handleSystemFile()">
                <div id="fileStatus" class="hidden" style="margin-top:10px; color:#28a745; font-weight:bold;"></div>
            </div>

            <div class="section hidden" id="configSection">
                <div class="section-title">âš™ï¸ æ­¥éª¤ 3ï¼šæ§åˆ¶å°</div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">é€‰æ‹©æŒ‡ä»¤ï¼š</label>
                    <select id="promptTemplate"><option value="">-- è¯·é€‰æ‹© --</option></select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-blue" id="startBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿäº§</button>
                    <button class="btn btn-orange hidden" id="pauseBtn" onclick="togglePause()">â¸ï¸ æš‚åœ (å¯å¯¼å‡º)</button>
                    <button class="btn btn-green hidden" id="downloadBtn" onclick="downloadResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                </div>
                
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
            <h3>ğŸ’¾ æœ€è¿‘ 5 æ¬¡ç”Ÿæˆè®°å½•</h3>
            <ul class="history-list" id="historyListUi">
                <li style="text-align:center; padding:20px; color:#999;">æš‚æ— è®°å½•</li>
            </ul>
        </div>
    </div>

    <script>
        const SHEET_NAMES = { keywords: "ğŸ”SEOå…³é”®è¯åº“", prompts: "ğŸ¤–AIç”ŸæˆæŒ‡ä»¤", tags: "ğŸ·ï¸è¯é¢˜æ ‡ç­¾SEOåº“", titles: "ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“" };
        let GLOBAL_DATA = { keywords: [], prompts: [], tags: [], titles: [], generated: [] };
        let isPaused = false;
        let isRunning = false;

        // ğŸŸ¢ 1. API Key è®°å¿†
        window.onload = function() {
            const savedKey = localStorage.getItem('xhs_user_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
        };
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return alert("è¯·è¾“å…¥Key");
            localStorage.setItem('xhs_user_api_key', key);
            alert("âœ… Key å·²ä¿å­˜");
        }

        // ğŸŸ¢ 2. å¤šæ¡å†å²è®°å½•ç®¡ç† (æ ¸å¿ƒå‡çº§)
        function saveToHistoryList(data) {
            if (!data || data.length === 0) return;
            
            let history = JSON.parse(localStorage.getItem('xhs_history_list') || "[]");
            
            // æ„å»ºæ–°è®°å½•
            const record = {
                id: new Date().getTime(),
                time: new Date().toLocaleString(),
                count: data.length,
                data: data
            };
            
            // æ’å…¥å¤´éƒ¨ï¼Œä¿ç•™æœ€è¿‘5æ¡
            history.unshift(record);
            if (history.length > 5) history = history.slice(0, 5);
            
            localStorage.setItem('xhs_history_list', JSON.stringify(history));
        }

        function showHistoryModal() {
            const history = JSON.parse(localStorage.getItem('xhs_history_list') || "[]");
            const ui = document.getElementById('historyListUi');
            ui.innerHTML = "";
            
            if (history.length === 0) {
                ui.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">æš‚æ— è®°å½•ï¼Œå¿«å»ç”Ÿæˆå§~</li>';
            } else {
                history.forEach((rec, index) => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div class="history-info">
                            <div>ğŸ•’ ${rec.time}</div>
                            <div style="font-size:12px; color:#999;">åŒ…å« ${rec.count} æ¡å†…å®¹</div>
                        </div>
                        <span class="history-tag">æ¢å¤</span>
                    `;
                    li.onclick = () => recoverFromHistory(index);
                    ui.appendChild(li);
                });
            }
            document.getElementById('historyModal').style.display = 'flex';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function recoverFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('xhs_history_list') || "[]");
            const record = history[index];
            if (record) {
                GLOBAL_DATA.generated = record.data; // æ¢å¤åˆ°å†…å­˜
                downloadResult(false, `å†å²æ¢å¤_${record.time}.xlsx`); // ç›´æ¥ä¸‹è½½
                closeHistoryModal();
            }
        }

        // ğŸŸ¢ 3. æš‚åœ/ç»§ç»­æ§åˆ¶
        function togglePause() {
            if (isPaused) {
                isPaused = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ (å¯å¯¼å‡º)";
                document.getElementById('pauseBtn').className = "btn btn-orange";
                document.getElementById('log').innerHTML += `<div style="color:#e6a23c">â–¶ï¸ ç»§ç»­ä»»åŠ¡...</div>`;
            } else {
                isPaused = true;
                document.getElementById('pauseBtn').innerText = "â–¶ï¸ å·²æš‚åœ (ç‚¹å‡»ç»§ç»­)";
                document.getElementById('pauseBtn').className = "btn btn-green";
                // æš‚åœæ—¶ç«‹åˆ»ä¿å­˜ä¸€æ¬¡å†å²ï¼Œé˜²æ­¢æ„å¤–å…³é—­
                saveToHistoryList(GLOBAL_DATA.generated);
                document.getElementById('log').innerHTML += `<div style="background:#fff3cd; color:#856404; padding:5px;">â¸ï¸ ä»»åŠ¡å·²æš‚åœï¼Œæ‚¨å¯ä»¥ç‚¹å‡»ã€å¯¼å‡ºç»“æœã€‘ä¸‹è½½ç›®å‰å·²ç”Ÿæˆçš„å†…å®¹ã€‚</div>`;
                // ç¡®ä¿å¯¼å‡ºæŒ‰é’®å¯è§
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        // ğŸŸ¢ 4. å¯¼å‡ºé€»è¾‘ (ä¿®å¤ç‚¹å‡»æ²¡ååº”çš„é—®é¢˜)
        function downloadResult(isPartial = false, customName = null) {
            if (!GLOBAL_DATA.generated || GLOBAL_DATA.generated.length === 0) {
                return alert("å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹");
            }
            
            const ws = XLSX.utils.json_to_sheet(GLOBAL_DATA.generated);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿæˆç»“æœ");
            
            let filename = customName;
            if (!filename) {
                const now = new Date();
                const timeStr = `${now.getHours()}${now.getMinutes()}`;
                filename = isPartial ? `ç”Ÿæˆç»“æœ_éƒ¨åˆ†_${timeStr}.xlsx` : `ç”Ÿæˆç»“æœ_å®Œæ•´_${timeStr}.xlsx`;
            }
            
            XLSX.writeFile(wb, filename);
        }

        // --- æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ---
        async function startGeneration() {
            let apiKey = document.getElementById('apiKey').value;
            if (!apiKey) apiKey = localStorage.getItem('xhs_user_api_key');
            
            const pIdx = document.getElementById('promptTemplate').value;
            if(!apiKey || pIdx === "") return alert("è¯·æ£€æŸ¥Keyå’ŒæŒ‡ä»¤");

            // UI åˆå§‹åŒ–
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden'); // å¼€å§‹å°±æ˜¾ç¤ºå¯¼å‡ºï¼Œæ–¹ä¾¿éšæ—¶å¯¼å‡º
            
            isPaused = false; 
            isRunning = true;
            
            const promptRow = GLOBAL_DATA.prompts[pIdx];
            const originalTemplate = promptRow['æŒ‡ä»¤å†…å®¹'];
            const log = document.getElementById('log');
            GLOBAL_DATA.generated = [];
            const tasks = GLOBAL_DATA.keywords;

            for(let i=0; i<tasks.length; i++) {
                // æš‚åœæ£€æµ‹å¾ªç¯
                while (isPaused) {
                    await new Promise(r => setTimeout(r, 500));
                }

                const row = tasks[i];
                const kw = row['å…³é”®è¯'];
                if(!kw) continue;

                let finalPrompt = originalTemplate;
                finalPrompt = finalPrompt.replace(/\{ä»SEOå…³é”®è¯åº“é€‰æ‹©\}/g, kw).replace(/\{å…³é”®è¯\}/g, kw);
                const price = row['ä»·æ ¼'] || "13.9"; 
                finalPrompt = finalPrompt.replace(/\{ä»·æ ¼\}/g, price);
                const material = row['æè´¨'] || "é“¶è‰²è´¨æ„Ÿ";
                finalPrompt = finalPrompt.replace(/\{æè´¨\}/g, material);
                
                const randomExamples = getRandomTitles(5);
                if (finalPrompt.includes("{éšæœºçˆ†æ¬¾æ ‡é¢˜}")) {
                    finalPrompt = finalPrompt.replace(/\{éšæœºçˆ†æ¬¾æ ‡é¢˜\}/g, randomExamples);
                } else if (randomExamples) {
                    finalPrompt += `\n\nã€å‚è€ƒä»¥ä¸‹çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘\n${randomExamples}`;
                }

                log.innerHTML += `<div>[${i+1}/${tasks.length}] æ­£åœ¨ç”Ÿæˆ: <b>${kw}</b></div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const res = await fetch("https://api.gptsapi.net/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                        body: JSON.stringify({ model: "gpt-4o", messages: [{role: "user", content: finalPrompt}], temperature: 0.8 })
                    });
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    const content = json.choices[0].message.content;
                    
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let title = "æœªç”Ÿæˆ";
                    let body = "";

                    if(lines.length > 0) {
                        let candidate = lines[0].replace(/\*\*/g, '').replace(/æ ‡é¢˜[:ï¼š]/g, '').trim();
                        if(candidate.length > 20) candidate = candidate.substring(0, 20); 
                        title = candidate;
                        lines.shift();
                        
                        let rawBody = lines.join('\n'); 
                        body = rawBody.replace(/æ­£æ–‡[:ï¼š]/g, '').replace(/#\S+/g, '').trim();
                        body = body.split(/è¯é¢˜æ ‡ç­¾|Tags/i)[0].trim();
                        
                        if (!body.includes('\n')) body = body.replace(/([ã€‚ï¼ï¼Ÿ])/g, "$1\n\n");
                    }

                    GLOBAL_DATA.generated.push({
                        "åºå·": i+1,
                        "å…³é”®è¯": kw,
                        "æ ‡é¢˜": title,
                        "æ­£æ–‡": body, 
                        "è¯é¢˜æ ‡ç­¾": getTags(),
                        "å¤‡æ³¨": `ğŸ’°${price} / ğŸ’${material}`
                    });
                    
                    // æ¯ç”Ÿæˆä¸€æ¡ï¼Œæ›´æ–°å†å²è®°å½• (è¦†ç›–æœ€æ–°çš„ä¸€æ¡ï¼Œè€Œä¸æ˜¯æ–°å¢)
                    // è¿™æ ·å¦‚æœæµè§ˆå™¨å´©äº†ï¼Œæœ€åä¸€æ¡è®°å½•å°±æ˜¯æœ€æ–°çš„
                    updateLatestHistory(GLOBAL_DATA.generated);

                } catch(e) { log.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`; }
                await new Promise(r => setTimeout(r, 800));
            }

            // å®ŒæˆçŠ¶æ€
            isRunning = false;
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            log.innerHTML += `<div style="color:#0f0">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
            downloadResult();
        }

        // è¾…åŠ©ï¼šæ›´æ–°æœ€æ–°çš„é‚£æ¡å†å²è®°å½• (è€Œä¸æ˜¯æ¯æ¬¡éƒ½æ–°å¢)
        function updateLatestHistory(data) {
            let history = JSON.parse(localStorage.getItem('xhs_history_list') || "[]");
            // å¦‚æœå†å²è®°å½•ä¸ºç©ºï¼Œæˆ–è€…ç¬¬ä¸€æ¡è®°å½•å¤ªè€ï¼ˆæ¯”å¦‚è¶…è¿‡1å°æ—¶ï¼‰ï¼Œå°±æ–°å¢ä¸€æ¡
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨ startGeneration å¼€å§‹æ—¶ä¸åšæ“ä½œï¼Œåœ¨è¿™é‡Œåˆ¤æ–­ï¼š
            // å¦‚æœå†…å­˜é‡Œçš„ GLOBAL_DATA.generated é•¿åº¦ä¸º 1ï¼Œè¯´æ˜æ˜¯æ–°ä»»åŠ¡ï¼Œunshift ä¸€æ¡æ–°è®°å½•
            // å¦‚æœé•¿åº¦ > 1ï¼Œè¯´æ˜æ˜¯å½“å‰ä»»åŠ¡çš„åç»­ï¼Œæ›´æ–° history[0]
            
            const nowStr = new Date().toLocaleString();
            
            if (data.length === 1) {
                // æ–°ä»»åŠ¡ï¼Œæ’å…¥å¤´éƒ¨
                history.unshift({ id: new Date().getTime(), time: nowStr, count: 1, data: data });
            } else if (history.length > 0) {
                // æ›´æ–°å½“å‰ä»»åŠ¡
                history[0].count = data.length;
                history[0].data = data;
                history[0].time = nowStr; // æ›´æ–°æ—¶é—´
            }
            
            // ä¿æŒ5æ¡
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('xhs_history_list', JSON.stringify(history));
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function downloadSmartTemplate() {
            const wb = XLSX.utils.book_new();
            const wsKw = XLSX.utils.aoa_to_sheet([["å…³é”®è¯", "ä¼˜å…ˆçº§", "ä»·æ ¼", "æè´¨", "å¤‡æ³¨"], ["æ°´æ³¢çº¹æˆ’æŒ‡", "â­â­â­", "13.9", "é“¶è‰²è´¨æ„Ÿ", "ç¤ºä¾‹"]]);
            XLSX.utils.book_append_sheet(wb, wsKw, SHEET_NAMES.keywords);
            
            const promptsData = [["æŒ‡ä»¤åç§°", "æŒ‡ä»¤å†…å®¹"], ["æŒ‡ä»¤1ï¼šçˆ†æ¬¾ä»¿å†™", `æˆ‘è¦åœ¨å°çº¢ä¹¦å‘æˆ’æŒ‡æ¨å¹¿ç¬”è®°ã€‚\nã€å…³é”®è¯ã€‘{ä»SEOå…³é”®è¯åº“é€‰æ‹©}\nã€å‚è€ƒæ ‡é¢˜ã€‘{éšæœºçˆ†æ¬¾æ ‡é¢˜}\n\nã€æ ‡é¢˜è¦æ±‚ã€‘\n20å­—å†…ï¼Œæ¨¡ä»¿å‚è€ƒæ ‡é¢˜çš„è¯­æ°”ã€‚\n\nã€æ­£æ–‡è¦æ±‚ã€‘\n1. è‡ªç„¶åˆ†æ®µ\n2. çªå‡º{ä»·æ ¼}å’Œ{æè´¨}\n3. å£è¯­åŒ–\n\nè¯·è¾“å‡ºï¼š\næ ‡é¢˜\næ­£æ–‡`]];
            const wsPrompt = XLSX.utils.aoa_to_sheet(promptsData);
            XLSX.utils.book_append_sheet(wb, wsPrompt, SHEET_NAMES.prompts);

            const wsTags = XLSX.utils.aoa_to_sheet([["æ ‡ç­¾å†…å®¹", "æ ‡ç­¾ç±»å‹"], ["#æˆ’æŒ‡", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"], ["#æˆ’æŒ‡æ¨è", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"]]);
            XLSX.utils.book_append_sheet(wb, wsTags, SHEET_NAMES.tags);
            const wsTitles = XLSX.utils.aoa_to_sheet([["çˆ†æ¬¾æ ‡é¢˜å†…å®¹"], ["æ•‘å‘½ğŸ†˜13.9çš„æˆ’æŒ‡è¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ï¼Ÿï¼"]]);
            XLSX.utils.book_append_sheet(wb, wsTitles, SHEET_NAMES.titles);
            XLSX.writeFile(wb, "æ ‡å‡†å¡«ç©ºæ¨¡æ¿_v4.0ç»“æ„.xlsx");
        }

        function handleSystemFile() {
            const file = document.getElementById('systemFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const findSheet = (name) => workbook.SheetNames.find(n => n.includes(name.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, "")));
                    let s1 = workbook.Sheets[SHEET_NAMES.keywords] || workbook.Sheets[findSheet("SEOå…³é”®è¯åº“")];
                    let s2 = workbook.Sheets[SHEET_NAMES.prompts] || workbook.Sheets[findSheet("AIç”ŸæˆæŒ‡ä»¤")];
                    let s3 = workbook.Sheets[SHEET_NAMES.tags] || workbook.Sheets[findSheet("è¯é¢˜æ ‡ç­¾SEOåº“")];
                    let s4 = workbook.Sheets[SHEET_NAMES.titles] || workbook.Sheets[findSheet("çˆ†æ¬¾æ ‡é¢˜åº“")];
                    if(s1) GLOBAL_DATA.keywords = XLSX.utils.sheet_to_json(s1);
                    if(s2) GLOBAL_DATA.prompts = XLSX.utils.sheet_to_json(s2);
                    if(s3) GLOBAL_DATA.tags = XLSX.utils.sheet_to_json(s3);
                    if(s4) GLOBAL_DATA.titles = XLSX.utils.sheet_to_json(s4).map(r => Object.values(r)[0]);
                    if (!s1 || !s2) return alert("âŒ è¡¨æ ¼ä¸å®Œæ•´");
                    document.getElementById('fileStatus').innerHTML = `âœ… åŠ è½½æˆåŠŸ`;
                    document.getElementById('fileStatus').classList.remove('hidden');
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    GLOBAL_DATA.prompts.forEach((row, i) => { if(row['æŒ‡ä»¤åç§°']) select.innerHTML += `<option value="${i}">${row['æŒ‡ä»¤åç§°']}</option>`; });
                    document.getElementById('configSection').classList.remove('hidden');
                } catch (err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function getTags() {
            if(!GLOBAL_DATA.tags.length) return "#æ¨è";
            const fixed = GLOBAL_DATA.tags.filter(t => t['æ ‡ç­¾ç±»å‹'] && t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            const others = GLOBAL_DATA.tags.filter(t => !t['æ ‡ç­¾ç±»å‹'] || !t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            return [...fixed, ...others.sort(() => 0.5 - Math.random()).slice(0, 7)].join(" ");
        }

        function getRandomTitles(count) {
            if (!GLOBAL_DATA.titles || GLOBAL_DATA.titles.length === 0) return "";
            const shuffled = [...GLOBAL_DATA.titles].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map((t, i) => `${i+1}. ${t}`).join("\n");
        }
    </script>
</body>
</html>
