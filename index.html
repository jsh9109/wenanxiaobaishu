<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOå†…å®¹çŸ©é˜µç”Ÿæˆç³»ç»Ÿ - v5.2 æœ¬åœ°è®°å¿†ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* v5.2 é£æ ¼ - æç®€å•†åŠ¡ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .header { background: #1890ff; color: white; padding: 25px; text-align: center; position: relative; }
        .header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 500; }
        
        .top-bar { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
        .history-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .history-btn:hover { background: rgba(255,255,255,0.3); }

        .content { padding: 30px; }
        .section { background: #fff; border-radius: 6px; padding: 20px; margin-bottom: 20px; border: 1px solid #e8e8e8; border-left: 4px solid #1890ff; }
        .section-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .info-box { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; padding: 12px; border-radius: 4px; font-size: 13px; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 500; margin-right: 10px; transition: 0.2s; }
        .btn-blue { background: #1890ff; }
        .btn-green { background: #52c41a; }
        .btn-gray { background: #8c8c8c; } 
        .log { margin-top: 15px; padding: 15px; background: #fafafa; color: #333; border-radius: 4px; max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #eee; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; }
        
        /* èƒ¶å›ŠæŒ‰é’®ç»„ */
        .input-group { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ æˆ’æŒ‡SEOå†…å®¹å·¥å‚ v5.2 (æœ¬åœ°è®°å¿†ç‰ˆ)</h1>
            <p>100% æ‰§è¡Œæ‚¨çš„ Excel æŒ‡ä»¤ | è‡ªåŠ¨è®°å¿† Key</p>
            <div class="top-bar">
                <button class="history-btn" onclick="recoverBackup()">ğŸ“‚ æ’¤é”€å›é€€(ä¸Šä¸€ç‰ˆ)</button>
                <button class="history-btn" onclick="recoverCurrent()">ğŸ“„ ä¸‹è½½å½“å‰è®°å½•</button>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“¥ æ­¥éª¤ 0ï¼šæ¨¡æ¿å‡†å¤‡</div>
                <div class="info-box">
                    â„¹ï¸ <b>ç³»ç»Ÿé€»è¾‘ï¼š</b><br>
                    æœ¬ç³»ç»Ÿå°†ä¸¥æ ¼è¯»å–æ‚¨ä¸Šä¼ è¡¨æ ¼ä¸­çš„ <b>[ğŸ¤–AIç”ŸæˆæŒ‡ä»¤]</b>ã€‚<br>
                    éœ€è¦ä¿®æ”¹æ–‡æ¡ˆé£æ ¼ï¼Ÿè¯·ç›´æ¥ä¿®æ”¹ Excel æŒ‡ä»¤ã€‚<br>
                    éœ€è¦å‚è€ƒçˆ†æ¬¾ï¼Ÿè¯·æ›´æ–° Excel çˆ†æ¬¾åº“ã€‚
                </div>
                <button class="btn btn-blue" onclick="downloadSmartTemplate()">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿_v4.0ç»“æ„.xlsx</button>
            </div>

            <div class="section">
                <div class="section-title">ğŸ”Œ æ­¥éª¤ 1ï¼šé…ç½® API (å·²æ”¯æŒè®°å¿†)</div>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                    <button class="btn btn-gray" onclick="saveApiKey()" style="margin-right:0;">ğŸ’¾ ä¿å­˜ Key</button>
                </div>
                <div id="keyStatus" style="font-size:12px; color:green; margin-top:5px; height:18px;"></div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“‚ æ­¥éª¤ 2ï¼šä¸Šä¼ æ‚¨çš„è¡¨æ ¼</div>
                <input type="file" id="systemFile" accept=".xlsx,.xls" onchange="handleSystemFile()">
                <div id="fileStatus" class="hidden" style="margin-top:10px; color:#52c41a; font-weight:bold;"></div>
            </div>

            <div class="section hidden" id="configSection">
                <div class="section-title">âš™ï¸ æ­¥éª¤ 3ï¼šé€‰æ‹©æŒ‡ä»¤å¹¶æ‰§è¡Œ</div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; font-size:12px; color:#666;">è¯·é€‰æ‹© Excel ä¸­å®šä¹‰çš„æŒ‡ä»¤ï¼š</label>
                    <select id="promptTemplate"><option value="">-- è¯·é€‰æ‹© --</option></select>
                </div>
                <button class="btn btn-blue" id="startBtn" onclick="startGeneration()">ğŸš€ ä¸¥æ ¼æ‰§è¡ŒæŒ‡ä»¤</button>
                <button class="btn btn-green hidden" id="downloadBtn" onclick="downloadResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_NAMES = { keywords: "ğŸ”SEOå…³é”®è¯åº“", prompts: "ğŸ¤–AIç”ŸæˆæŒ‡ä»¤", tags: "ğŸ·ï¸è¯é¢˜æ ‡ç­¾SEOåº“", titles: "ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“" };
        let GLOBAL_DATA = { keywords: [], prompts: [], tags: [], titles: [], generated: [] };

        // ğŸŸ¢ æ ¸å¿ƒï¼šKey è®°å¿†åŠŸèƒ½
        window.onload = function() {
            const savedKey = localStorage.getItem('xhs_user_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('keyStatus').textContent = "âœ… å·²è‡ªåŠ¨åŠ è½½æœ¬åœ°ä¿å­˜çš„ Key";
            }
        };

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return alert("è¯·å…ˆè¾“å…¥ Key");
            localStorage.setItem('xhs_user_api_key', key);
            document.getElementById('keyStatus').textContent = "âœ… Key å·²ä¿å­˜ï¼Œä¸‹æ¬¡æ— éœ€è¾“å…¥ï¼";
            alert("Key å·²ä¿å­˜ï¼");
        }

        // --- å†å²å¤‡ä»½åŠŸèƒ½ ---
        function backupData() {
            const lastSession = localStorage.getItem('xhs_latest_session');
            if (lastSession) localStorage.setItem('xhs_backup_session', lastSession);
        }
        function recoverBackup() {
            const data = localStorage.getItem('xhs_backup_session');
            if (!data) return alert("æ— å¤‡ä»½è®°å½•");
            exportExcel(JSON.parse(data), `æ¢å¤_å¤‡ä»½_${new Date().getTime()}.xlsx`);
        }
        function recoverCurrent() {
            const data = localStorage.getItem('xhs_latest_session');
            if (!data) return alert("æ— å½“å‰è®°å½•");
            exportExcel(JSON.parse(data), `æ¢å¤_å½“å‰_${new Date().getTime()}.xlsx`);
        }
        function exportExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿæˆç»“æœ");
            XLSX.writeFile(wb, filename);
        }

        // --- æ¨¡æ¿ä¸‹è½½ ---
        function downloadSmartTemplate() {
            const wb = XLSX.utils.book_new();
            const wsKw = XLSX.utils.aoa_to_sheet([["å…³é”®è¯", "ä¼˜å…ˆçº§", "ä»·æ ¼", "æè´¨", "å¤‡æ³¨"], ["æ°´æ³¢çº¹æˆ’æŒ‡", "â­â­â­", "13.9", "é“¶è‰²è´¨æ„Ÿ", "ç¤ºä¾‹"]]);
            XLSX.utils.book_append_sheet(wb, wsKw, SHEET_NAMES.keywords);
            
            const promptsData = [
                ["æŒ‡ä»¤åç§°", "æŒ‡ä»¤å†…å®¹"],
                ["æŒ‡ä»¤1ï¼šçˆ†æ¬¾ä»¿å†™", `æˆ‘è¦åœ¨å°çº¢ä¹¦å‘æˆ’æŒ‡æ¨å¹¿ç¬”è®°ã€‚\nã€å…³é”®è¯ã€‘{ä»SEOå…³é”®è¯åº“é€‰æ‹©}\nã€å‚è€ƒæ ‡é¢˜ã€‘{éšæœºçˆ†æ¬¾æ ‡é¢˜}\n\nã€æ ‡é¢˜è¦æ±‚ã€‘\n20å­—å†…ï¼Œæ¨¡ä»¿å‚è€ƒæ ‡é¢˜çš„è¯­æ°”ã€‚\n\nã€æ­£æ–‡è¦æ±‚ã€‘\n1. è‡ªç„¶åˆ†æ®µ\n2. çªå‡º{ä»·æ ¼}å’Œ{æè´¨}\n3. å£è¯­åŒ–ï¼Œä¸è¦AIå‘³\n\nè¯·è¾“å‡ºï¼š\næ ‡é¢˜\næ­£æ–‡`],
            ];
            const wsPrompt = XLSX.utils.aoa_to_sheet(promptsData);
            XLSX.utils.book_append_sheet(wb, wsPrompt, SHEET_NAMES.prompts);

            const wsTags = XLSX.utils.aoa_to_sheet([["æ ‡ç­¾å†…å®¹", "æ ‡ç­¾ç±»å‹"], ["#æˆ’æŒ‡", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"], ["#æˆ’æŒ‡æ¨è", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"]]);
            XLSX.utils.book_append_sheet(wb, wsTags, SHEET_NAMES.tags);
            const wsTitles = XLSX.utils.aoa_to_sheet([["çˆ†æ¬¾æ ‡é¢˜å†…å®¹"], ["æ•‘å‘½ğŸ†˜13.9çš„æˆ’æŒ‡è¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ï¼Ÿï¼"]]);
            XLSX.utils.book_append_sheet(wb, wsTitles, SHEET_NAMES.titles);

            XLSX.writeFile(wb, "æ ‡å‡†å¡«ç©ºæ¨¡æ¿_v4.0ç»“æ„.xlsx");
        }

        // --- æ–‡ä»¶è¯»å– ---
        function handleSystemFile() {
            const file = document.getElementById('systemFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const findSheet = (name) => workbook.SheetNames.find(n => n.includes(name.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, "")));
                    
                    let s1 = workbook.Sheets[SHEET_NAMES.keywords] || workbook.Sheets[findSheet("SEOå…³é”®è¯åº“")];
                    let s2 = workbook.Sheets[SHEET_NAMES.prompts] || workbook.Sheets[findSheet("AIç”ŸæˆæŒ‡ä»¤")];
                    let s3 = workbook.Sheets[SHEET_NAMES.tags] || workbook.Sheets[findSheet("è¯é¢˜æ ‡ç­¾SEOåº“")];
                    let s4 = workbook.Sheets[SHEET_NAMES.titles] || workbook.Sheets[findSheet("çˆ†æ¬¾æ ‡é¢˜åº“")];

                    if(s1) GLOBAL_DATA.keywords = XLSX.utils.sheet_to_json(s1);
                    if(s2) GLOBAL_DATA.prompts = XLSX.utils.sheet_to_json(s2);
                    if(s3) GLOBAL_DATA.tags = XLSX.utils.sheet_to_json(s3);
                    if(s4) GLOBAL_DATA.titles = XLSX.utils.sheet_to_json(s4).map(r => Object.values(r)[0]);

                    if (!s1 || !s2) return alert("âŒ è¡¨æ ¼ç»“æ„ä¸å®Œæ•´ï¼Œè¯·ç¡®ä¿åŒ…å«å¿…è¦çš„Sheet");

                    document.getElementById('fileStatus').innerHTML = `âœ… å·²åŠ è½½æŒ‡ä»¤åº“ï¼šå…± ${GLOBAL_DATA.prompts.length} æ¡æŒ‡ä»¤`;
                    document.getElementById('fileStatus').classList.remove('hidden');
                    
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    GLOBAL_DATA.prompts.forEach((row, i) => { if(row['æŒ‡ä»¤åç§°']) select.innerHTML += `<option value="${i}">${row['æŒ‡ä»¤åç§°']}</option>`; });
                    document.getElementById('configSection').classList.remove('hidden');
                } catch (err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function getTags() {
            if(!GLOBAL_DATA.tags.length) return "#æ¨è";
            const fixed = GLOBAL_DATA.tags.filter(t => t['æ ‡ç­¾ç±»å‹'] && t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            const others = GLOBAL_DATA.tags.filter(t => !t['æ ‡ç­¾ç±»å‹'] || !t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            return [...fixed, ...others.sort(() => 0.5 - Math.random()).slice(0, 7)].join(" ");
        }

        function getRandomTitles(count) {
            if (!GLOBAL_DATA.titles || GLOBAL_DATA.titles.length === 0) return "";
            const shuffled = [...GLOBAL_DATA.titles].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map((t, i) => `${i+1}. ${t}`).join("\n");
        }

        // --- ç”Ÿæˆé€»è¾‘ ---
        async function startGeneration() {
            let apiKey = document.getElementById('apiKey').value;
            // è‡ªåŠ¨è¡¥æ•‘ï¼šå¦‚æœæ¡†é‡Œæ²¡å¡«ï¼Œå°è¯•å»ç¼“å­˜æ‹¿
            if (!apiKey) apiKey = localStorage.getItem('xhs_user_api_key');
            
            const pIdx = document.getElementById('promptTemplate').value;
            if(!apiKey || pIdx === "") return alert("è¯·é…ç½®APIå’ŒæŒ‡ä»¤");

            backupData(); // å¤‡ä»½

            document.getElementById('startBtn').disabled = true;
            document.getElementById('downloadBtn').classList.add('hidden');
            
            const promptRow = GLOBAL_DATA.prompts[pIdx];
            const originalTemplate = promptRow['æŒ‡ä»¤å†…å®¹'];
            
            const log = document.getElementById('log');
            GLOBAL_DATA.generated = [];
            const tasks = GLOBAL_DATA.keywords;

            for(let i=0; i<tasks.length; i++) {
                const row = tasks[i];
                const kw = row['å…³é”®è¯'];
                if(!kw) continue;

                let finalPrompt = originalTemplate;
                // 1. å˜é‡æ›¿æ¢
                finalPrompt = finalPrompt.replace(/\{ä»SEOå…³é”®è¯åº“é€‰æ‹©\}/g, kw).replace(/\{å…³é”®è¯\}/g, kw);
                const price = row['ä»·æ ¼'] || "13.9"; 
                finalPrompt = finalPrompt.replace(/\{ä»·æ ¼\}/g, price);
                const material = row['æè´¨'] || "é“¶è‰²è´¨æ„Ÿ";
                finalPrompt = finalPrompt.replace(/\{æè´¨\}/g, material);
                
                // 2. çˆ†æ¬¾æ ‡é¢˜åº“æ³¨å…¥
                const randomExamples = getRandomTitles(5);
                if (finalPrompt.includes("{éšæœºçˆ†æ¬¾æ ‡é¢˜}")) {
                    finalPrompt = finalPrompt.replace(/\{éšæœºçˆ†æ¬¾æ ‡é¢˜\}/g, randomExamples);
                } else if (randomExamples) {
                    finalPrompt += `\n\nã€å‚è€ƒä»¥ä¸‹çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘\n${randomExamples}`;
                }

                log.innerHTML += `<div>[${i+1}/${tasks.length}] æ‰§è¡ŒæŒ‡ä»¤: <b>${kw}</b></div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const res = await fetch("https://api.gptsapi.net/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                        body: JSON.stringify({ model: "gpt-4o", messages: [{role: "user", content: finalPrompt}], temperature: 0.8 })
                    });
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    const content = json.choices[0].message.content;
                    
                    // 3. ç»“æœè§£æ
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let title = "æœªç”Ÿæˆ";
                    let body = "";

                    if(lines.length > 0) {
                        let candidate = lines[0].replace(/\*\*/g, '').replace(/æ ‡é¢˜[:ï¼š]/g, '').trim();
                        if(candidate.length > 20) candidate = candidate.substring(0, 20); 
                        title = candidate;
                        lines.shift();
                        
                        let rawBody = lines.join('\n'); 
                        body = rawBody.replace(/æ­£æ–‡[:ï¼š]/g, '').replace(/#\S+/g, '').trim();
                        body = body.split(/è¯é¢˜æ ‡ç­¾|Tags/i)[0].trim();
                        
                        if (!body.includes('\n')) {
                             body = body.replace(/([ã€‚ï¼ï¼Ÿ])/g, "$1\n\n");
                        }
                    }

                    GLOBAL_DATA.generated.push({
                        "åºå·": i+1,
                        "å…³é”®è¯": kw,
                        "æ ‡é¢˜": title,
                        "æ­£æ–‡": body, 
                        "è¯é¢˜æ ‡ç­¾": getTags(),
                        "å¤‡æ³¨": `ğŸ’°${price} / ğŸ’${material}`
                    });
                    
                    localStorage.setItem('xhs_latest_session', JSON.stringify(GLOBAL_DATA.generated));

                } catch(e) { log.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`; }
                await new Promise(r => setTimeout(r, 800));
            }

            document.getElementById('downloadBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            log.innerHTML += `<div style="color:#0f0">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
            exportExcel(GLOBAL_DATA.generated, `æœ€ç»ˆç»“æœ_v5.2.xlsx`);
        }
    </script>
</body>
</html>
