<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOå†…å®¹çŸ©é˜µç”Ÿæˆç³»ç»Ÿ - v5.5 å¼ºåŠ›æ¸…æ´—ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* v5.5 é£æ ¼ - ç¨³å®šå¯é  */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .header { background: #001529; color: white; padding: 25px; text-align: center; position: relative; }
        .header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 500; }
        
        .top-bar { margin-top: 15px; display: flex; justify-content: center; gap: 15px; }
        .history-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .history-btn:hover { background: rgba(255,255,255,0.3); }

        .content { padding: 30px; }
        .section { background: #fff; border-radius: 6px; padding: 20px; margin-bottom: 20px; border: 1px solid #e8e8e8; border-left: 4px solid #001529; }
        .section-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .info-box { background: #e6f7ff; border: 1px solid #91d5ff; color: #001529; padding: 12px; border-radius: 4px; font-size: 13px; margin-bottom: 15px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 500; margin-right: 10px; transition: 0.2s; }
        .btn-blue { background: #1890ff; }
        .btn-green { background: #52c41a; }
        .btn-orange { background: #fa8c16; }
        .log { margin-top: 15px; padding: 15px; background: #fafafa; color: #333; border-radius: 4px; max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #eee; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; }
        .input-group { display: flex; gap: 10px; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .history-list { list-style: none; padding: 0; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .history-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’ æˆ’æŒ‡SEOå†…å®¹å·¥å‚ v5.5 (å¼ºåŠ›æ¸…æ´—ç‰ˆ)</h1>
            <p>è‡ªåŠ¨å»é™¤ä¹±ç  | æ ‡é¢˜è‡ªåŠ¨å½’ä½ | å®Œç¾å…¼å®¹é‡è·¯å­æŒ‡ä»¤</p>
            <div class="top-bar">
                <button class="history-btn" onclick="showHistoryModal()">ğŸ“œ å†å²è®°å½•</button>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">ğŸ“¥ æ­¥éª¤ 0ï¼šæ¨¡æ¿å‡†å¤‡</div>
                <div class="info-box">
                    ğŸ› ï¸ <b>ä¿®å¤è¯´æ˜ï¼š</b><br>
                    æ— éœ€æ›´æ¢æ¨¡æ¿ï¼ç»§ç»­ä½¿ç”¨æ‚¨çš„<b>"çˆ†æ¬¾ä¿®æ­£ç‰ˆ"</b>æ¨¡æ¿å³å¯ã€‚<br>
                    æœ¬ç³»ç»Ÿå·²å‡çº§æ¸…æ´—ç®—æ³•ï¼Œæ— è®ºAIè¾“å‡ºå¤šå°‘"###"æˆ–"æ­£æ–‡ï¼š"ç­‰ä¹±ç ï¼Œéƒ½èƒ½è‡ªåŠ¨æ´—å¹²å‡€ã€‚
                </div>
                <button class="btn btn-blue" onclick="downloadSmartTemplate()">ğŸ“¥ ä¸‹è½½æ ‡å‡†æ¨¡æ¿_v5.4.xlsx</button>
            </div>

            <div class="section">
                <div class="section-title">ğŸ”Œ æ­¥éª¤ 1ï¼šé…ç½® API</div>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                    <button class="btn btn-green" onclick="saveApiKey()" style="margin-right:0;">ğŸ’¾ ä¿å­˜ Key</button>
                </div>
                <div id="keyStatus" style="font-size:12px; color:green; margin-top:5px; height:18px;"></div>
            </div>

            <div class="section">
                <div class="section-title">ğŸ“‚ æ­¥éª¤ 2ï¼šä¸Šä¼ æ‚¨çš„è¡¨æ ¼</div>
                <input type="file" id="systemFile" accept=".xlsx,.xls" onchange="handleSystemFile()">
                <div id="fileStatus" class="hidden" style="margin-top:10px; color:#52c41a; font-weight:bold;"></div>
            </div>

            <div class="section hidden" id="configSection">
                <div class="section-title">âš™ï¸ æ­¥éª¤ 3ï¼šæ‰§è¡Œ</div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; font-size:12px; color:#666;">è¯·é€‰æ‹©æŒ‡ä»¤ï¼š</label>
                    <select id="promptTemplate"><option value="">-- è¯·é€‰æ‹© --</option></select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-blue" id="startBtn" onclick="startGeneration()">ğŸš€ å¼€å§‹ç”Ÿäº§</button>
                    <button class="btn btn-orange hidden" id="pauseBtn" onclick="togglePause()">â¸ï¸ æš‚åœ (å¯å¯¼å‡º)</button>
                    <button class="btn btn-green hidden" id="downloadBtn" onclick="downloadResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                </div>
                
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ’¾ å†å²è®°å½•</h3>
            <ul class="history-list" id="historyListUi"></ul>
            <button class="btn btn-blue" onclick="document.getElementById('historyModal').style.display='none'" style="width:100%; margin-top:10px;">å…³é—­</button>
        </div>
    </div>

    <script>
        const SHEET_NAMES = { keywords: "ğŸ”SEOå…³é”®è¯åº“", prompts: "ğŸ¤–AIç”ŸæˆæŒ‡ä»¤", tags: "ğŸ·ï¸è¯é¢˜æ ‡ç­¾SEOåº“", titles: "ğŸ”¥çˆ†æ¬¾æ ‡é¢˜åº“" };
        let GLOBAL_DATA = { keywords: [], prompts: [], tags: [], titles: [], generated: [] };
        let isPaused = false;

        // Key è®°å¿†
        window.onload = function() {
            const savedKey = localStorage.getItem('xhs_user_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('keyStatus').textContent = "âœ… Key å·²åŠ è½½";
            }
        };
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) return alert("è¯·è¾“å…¥ Key");
            localStorage.setItem('xhs_user_api_key', key);
            document.getElementById('keyStatus').textContent = "âœ… Key å·²ä¿å­˜";
        }

        // å†å²è®°å½•
        function saveToHistoryList(data) {
            if (!data || data.length === 0) return;
            let history = JSON.parse(localStorage.getItem('xhs_history_list_v5') || "[]");
            const record = { id: new Date().getTime(), time: new Date().toLocaleString(), count: data.length, data: data };
            history.unshift(record);
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('xhs_history_list_v5', JSON.stringify(history));
        }

        function showHistoryModal() {
            const history = JSON.parse(localStorage.getItem('xhs_history_list_v5') || "[]");
            const ui = document.getElementById('historyListUi');
            ui.innerHTML = "";
            if(history.length === 0) ui.innerHTML = "<li style='color:#999;text-align:center;'>æš‚æ— è®°å½•</li>";
            history.forEach((rec) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `<div>${rec.time} <small>(${rec.count}æ¡)</small></div> <span style="color:#1890ff;">ä¸‹è½½</span>`;
                li.onclick = () => { exportExcel(rec.data, `å†å²æ¢å¤_${rec.id}.xlsx`); document.getElementById('historyModal').style.display = 'none'; };
                ui.appendChild(li);
            });
            document.getElementById('historyModal').style.display = 'flex';
        }

        function exportExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿæˆç»“æœ");
            XLSX.writeFile(wb, filename);
        }

        function downloadSmartTemplate() {
            const wb = XLSX.utils.book_new();
            const wsKw = XLSX.utils.aoa_to_sheet([["å…³é”®è¯", "ä¼˜å…ˆçº§", "ä»·æ ¼", "æè´¨", "å¤‡æ³¨"], ["æ°´æ³¢çº¹æˆ’æŒ‡", "â­â­â­", "13.9", "é“¶è‰²è´¨æ„Ÿ", "ç¤ºä¾‹"]]);
            XLSX.utils.book_append_sheet(wb, wsKw, SHEET_NAMES.keywords);
            
            const promptsData = [["æŒ‡ä»¤åç§°", "æŒ‡ä»¤å†…å®¹"], ["æŒ‡ä»¤1ï¼šçˆ†æ¬¾ä¿®æ­£æ¨¡å¼", `ã€è§’è‰²è®¾å®šã€‘\næ¿€åŠ¨å¾—è¯­æ— ä¼¦æ¬¡çš„å¥³ç”Ÿã€‚\nã€æ ¸å¿ƒå…³é”®è¯ã€‘{ä»SEOå…³é”®è¯åº“é€‰æ‹©}\nã€æ ‡é¢˜è¦æ±‚ã€‘å¯¹è¯ä½“+åœºæ™¯+æ•°å­—ï¼\nã€æ­£æ–‡è¦æ±‚ã€‘æ¯ä¸€å¥è¯éƒ½è¦æ¢è¡Œï¼ä¸è¦ç”¨é€—å·ã€‚å¿…é¡»åŒ…å«åœºæ™¯ã€ç—›ç‚¹ã€ç»†èŠ‚ã€é€¼å•ã€‚\nè¯·è¾“å‡ºï¼š\næ ‡é¢˜\næ­£æ–‡`]];
            const wsPrompt = XLSX.utils.aoa_to_sheet(promptsData);
            XLSX.utils.book_append_sheet(wb, wsPrompt, SHEET_NAMES.prompts);

            const wsTags = XLSX.utils.aoa_to_sheet([["æ ‡ç­¾å†…å®¹", "æ ‡ç­¾ç±»å‹"], ["#æˆ’æŒ‡", "å›ºå®šæ ¸å¿ƒæ ‡ç­¾"]]);
            XLSX.utils.book_append_sheet(wb, wsTags, SHEET_NAMES.tags);
            const wsTitles = XLSX.utils.aoa_to_sheet([["çˆ†æ¬¾æ ‡é¢˜å†…å®¹"], ["æ•‘å‘½ğŸ†˜13.9çš„æˆ’æŒ‡è¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ï¼Ÿï¼"]]);
            XLSX.utils.book_append_sheet(wb, wsTitles, SHEET_NAMES.titles);
            XLSX.writeFile(wb, "æ ‡å‡†å¡«ç©ºæ¨¡æ¿_v5.4_ä¿®æ­£çˆ†æ¬¾ç‰ˆ.xlsx");
        }

        function handleSystemFile() {
            const file = document.getElementById('systemFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const findSheet = (name) => workbook.SheetNames.find(n => n.includes(name.replace(/[^a-zA-Z\u4e00-\u9fa5]/g, "")));
                    let s1 = workbook.Sheets[SHEET_NAMES.keywords] || workbook.Sheets[findSheet("SEOå…³é”®è¯åº“")];
                    let s2 = workbook.Sheets[SHEET_NAMES.prompts] || workbook.Sheets[findSheet("AIç”ŸæˆæŒ‡ä»¤")];
                    let s3 = workbook.Sheets[SHEET_NAMES.tags] || workbook.Sheets[findSheet("è¯é¢˜æ ‡ç­¾SEOåº“")];
                    let s4 = workbook.Sheets[SHEET_NAMES.titles] || workbook.Sheets[findSheet("çˆ†æ¬¾æ ‡é¢˜åº“")];

                    if(s1) GLOBAL_DATA.keywords = XLSX.utils.sheet_to_json(s1);
                    if(s2) GLOBAL_DATA.prompts = XLSX.utils.sheet_to_json(s2);
                    if(s3) GLOBAL_DATA.tags = XLSX.utils.sheet_to_json(s3);
                    if(s4) GLOBAL_DATA.titles = XLSX.utils.sheet_to_json(s4).map(r => Object.values(r)[0]);

                    if (!s1 || !s2) return alert("âŒ è¡¨æ ¼ä¸å®Œæ•´");
                    document.getElementById('fileStatus').innerHTML = `âœ… åŠ è½½æˆåŠŸ`;
                    document.getElementById('fileStatus').classList.remove('hidden');
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    GLOBAL_DATA.prompts.forEach((row, i) => { if(row['æŒ‡ä»¤åç§°']) select.innerHTML += `<option value="${i}">${row['æŒ‡ä»¤åç§°']}</option>`; });
                    document.getElementById('configSection').classList.remove('hidden');
                } catch (err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function getTags() {
            if(!GLOBAL_DATA.tags.length) return "#æ¨è";
            const fixed = GLOBAL_DATA.tags.filter(t => t['æ ‡ç­¾ç±»å‹'] && t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            const others = GLOBAL_DATA.tags.filter(t => !t['æ ‡ç­¾ç±»å‹'] || !t['æ ‡ç­¾ç±»å‹'].includes('å›ºå®š')).map(t=>t['æ ‡ç­¾å†…å®¹']);
            return [...fixed, ...others.sort(() => 0.5 - Math.random()).slice(0, 7)].join(" ");
        }

        function getRandomTitles(count) {
            if (!GLOBAL_DATA.titles || GLOBAL_DATA.titles.length === 0) return "";
            const shuffled = [...GLOBAL_DATA.titles].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map((t, i) => `${i+1}. ${t}`).join("\n");
        }

        function togglePause() {
            if (isPaused) {
                isPaused = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ (å¯å¯¼å‡º)";
                document.getElementById('pauseBtn').className = "btn btn-orange";
            } else {
                isPaused = true;
                document.getElementById('pauseBtn').innerText = "â–¶ï¸ å·²æš‚åœ (ç‚¹å‡»ç»§ç»­)";
                document.getElementById('pauseBtn').className = "btn btn-green";
                saveToHistoryList(GLOBAL_DATA.generated);
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        function downloadResult() {
            if (!GLOBAL_DATA.generated || GLOBAL_DATA.generated.length === 0) return alert("æ— æ•°æ®");
            const now = new Date();
            const timeStr = `${now.getHours()}${now.getMinutes()}`;
            exportExcel(GLOBAL_DATA.generated, `ç”Ÿæˆç»“æœ_${timeStr}.xlsx`);
            saveToHistoryList(GLOBAL_DATA.generated);
        }

        // --- æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (å‡çº§æ¸…æ´—ç‰ˆ) ---
        async function startGeneration() {
            let apiKey = document.getElementById('apiKey').value;
            if (!apiKey) apiKey = localStorage.getItem('xhs_user_api_key');
            
            const pIdx = document.getElementById('promptTemplate').value;
            if(!apiKey || pIdx === "") return alert("è¯·é…ç½®APIå’ŒæŒ‡ä»¤");

            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            
            isPaused = false; 
            
            const promptRow = GLOBAL_DATA.prompts[pIdx];
            const originalTemplate = promptRow['æŒ‡ä»¤å†…å®¹'];
            const log = document.getElementById('log');
            GLOBAL_DATA.generated = [];
            const tasks = GLOBAL_DATA.keywords;

            for(let i=0; i<tasks.length; i++) {
                while(isPaused) { await new Promise(r => setTimeout(r, 500)); }

                const row = tasks[i];
                const kw = row['å…³é”®è¯'];
                if(!kw) continue;

                let finalPrompt = originalTemplate;
                finalPrompt = finalPrompt.replace(/\{ä»SEOå…³é”®è¯åº“é€‰æ‹©\}/g, kw).replace(/\{å…³é”®è¯\}/g, kw);
                const price = row['ä»·æ ¼'] || "13.9"; 
                finalPrompt = finalPrompt.replace(/\{ä»·æ ¼\}/g, price);
                const material = row['æè´¨'] || "é“¶è‰²è´¨æ„Ÿ";
                finalPrompt = finalPrompt.replace(/\{æè´¨\}/g, material);
                
                const randomExamples = getRandomTitles(5);
                if (finalPrompt.includes("{éšæœºçˆ†æ¬¾æ ‡é¢˜}")) {
                    finalPrompt = finalPrompt.replace(/\{éšæœºçˆ†æ¬¾æ ‡é¢˜\}/g, randomExamples);
                } else if (randomExamples) {
                    finalPrompt += `\n\nã€å‚è€ƒä»¥ä¸‹çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘\n${randomExamples}`;
                }

                log.innerHTML += `<div>[${i+1}/${tasks.length}] æ­£åœ¨ç”Ÿæˆ: <b>${kw}</b></div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const res = await fetch("https://api.gptsapi.net/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                        body: JSON.stringify({ model: "gpt-4o", messages: [{role: "user", content: finalPrompt}], temperature: 0.8 })
                    });
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    const content = json.choices[0].message.content;
                    
                    // ğŸ”´ğŸ”´ğŸ”´ å¼ºåŠ›æ¸…æ´—é€»è¾‘ (Super Cleaner) ğŸ”´ğŸ”´ğŸ”´
                    
                    // 1. å»é™¤æ‰€æœ‰ Markdown ç¬¦å·å’Œå¸¸è§ Label
                    const cleanStr = (str) => {
                        return str.replace(/\*\*/g, '') // å»ç²—ä½“
                                  .replace(/###/g, '')   // å»æ ‡é¢˜ç¬¦
                                  .replace(/ã€|ã€‘/g, '') // å»æ‹¬å·
                                  .trim();
                    };

                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    let title = "æœªç”Ÿæˆ";
                    let body = "";

                    if(lines.length > 0) {
                        // å¼ºåˆ¶ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜
                        let candidate = cleanStr(lines[0]);
                        // å»æ‰ "æ ‡é¢˜ï¼š" "Title:" ç­‰å‰ç¼€
                        candidate = candidate.replace(/^(æ ‡é¢˜|Title)[:ï¼š]?\s*/i, '');
                        
                        if(candidate.length > 20) candidate = candidate.substring(0, 20); 
                        title = candidate;
                        lines.shift(); // ç§»é™¤ç¬¬ä¸€è¡Œ
                        
                        // å‰©ä¸‹çš„å…¨éƒ¨ä½œä¸ºæ­£æ–‡
                        let rawBody = lines.join('\n'); 
                        
                        // å†æ¬¡æ¸…æ´—æ­£æ–‡é‡Œçš„æ‚è´¨
                        body = cleanStr(rawBody);
                        // å»æ‰ "æ­£æ–‡ï¼š" "Body:" ç­‰å‰ç¼€ï¼ˆå¦‚æœAIåœ¨ç¬¬äºŒè¡Œåˆå†™äº†ä¸€éï¼‰
                        body = body.replace(/^(æ­£æ–‡|Body)[:ï¼š]?\s*/i, '');
                        
                        // å»æ‰åº•éƒ¨æ ‡ç­¾
                        body = body.replace(/#\S+/g, '').split(/è¯é¢˜æ ‡ç­¾|Tags/i)[0].trim();
                        
                        // æ™ºèƒ½è¡¥æ•‘ï¼šå¦‚æœAIå®Œå…¨æ²¡æ¢è¡Œï¼Œæˆ‘ä»¬å¸®å®ƒæ¢
                        if (!body.includes('\n')) body = body.replace(/([ã€‚ï¼ï¼Ÿ])/g, "$1\n\n");
                    }

                    GLOBAL_DATA.generated.push({
                        "åºå·": i+1,
                        "å…³é”®è¯": kw,
                        "æ ‡é¢˜": title,
                        "æ­£æ–‡": body, 
                        "è¯é¢˜æ ‡ç­¾": getTags(),
                        "å¤‡æ³¨": `ğŸ’°${price} / ğŸ’${material}`
                    });
                    
                } catch(e) { log.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`; }
                await new Promise(r => setTimeout(r, 800));
            }

            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = false;
            log.innerHTML += `<div style="color:#0f0">ğŸ‰ å…¨éƒ¨å®Œæˆï¼</div>`;
            downloadResult();
        }
    </script>
</body>
</html>
